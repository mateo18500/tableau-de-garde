<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tableau de Garde - H√¥pital (Firebase)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1226aa; --muted:#94a3b8; --text:#e2e8f0;
      --accent:#2563eb; --accent2:#7c3aed; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    body{ margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 900px at 20% -10%, #1e293b 0%, #0f172a 60%); }
    .header{ padding:20px 12px; text-align:center;
      background: linear-gradient(135deg, rgba(37,99,235,.35), rgba(124,58,237,.30));
      border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); }
    .header h1{margin:0; font-size:26px}
    #date { font-size: 1.4rem; font-weight: 600; color: #f1f5f9; letter-spacing:.5px; margin-top: 6px; text-shadow:0 1px 2px rgba(0,0,0,.4); }

    .sync-bar{display:flex; gap:10px; align-items:center; justify-content:center; font-size:13px; padding:8px 10px; opacity:.9}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.idle{background:#64748b}.dot.saving{background:var(--warn);animation:pulse 1.1s infinite}.dot.online{background:var(--ok)}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.22)}100%{transform:scale(1)}}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; padding:10px}
    button{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer;
      backdrop-filter: blur(6px); transition:.2s;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.25)}
    button.secondary{border-color: rgba(37,99,235,.4)}
    button.danger{border-color: rgba(239,68,68,.4)}

    /* Grille principale */
    .container{display:grid; grid-template-columns: 1.1fr 1.9fr; gap:16px; padding:14px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .card,.board{background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px}
    .section-header{font-weight:700; letter-spacing:.3px; margin:2px 0 8px; text-align:center; color:#dbeafe}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    th,td{padding:10px 10px; text-align:center}
    thead th{background: linear-gradient(180deg, rgba(37,99,235,.30), rgba(124,58,237,.18)); border-bottom:1px solid rgba(255,255,255,.12); font-size:13px}
    tbody td{border-top:1px solid rgba(255,255,255,.06)}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; outline: none;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--text);
    }
    input::placeholder, textarea::placeholder{color:#94a3b866}
    .actions{display:flex; gap:6px; justify-content:center}
    .tag{ font-size:1.1rem; padding:4px 10px; color:#fff; background:#1e40af; border:1px solid rgba(255,255,255,.18); border-radius:10px; display:inline-block; margin-right:6px; }
    .tag.j{ background:#2563eb; } .tag.n{ background:#dc2626; }
    .service-badge{display:inline-block; padding:2px 7px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06)}
    .td-left{ text-align:left; color:#cbd5e1; font-weight:600; }
    .tight table tbody td{padding-top:6px; padding-bottom:6px}

    /* Grilles √† droite */
    .right-grid { display:grid; grid-template-columns: repeat(2, minmax(340px, 1fr)); gap:12px; align-items:start; }
    .lower-grid { display:grid; grid-template-columns: repeat(2, minmax(340px, 1fr)); gap:12px; align-items:start; margin-top:12px; }
    @media (max-width: 1200px) { .right-grid, .lower-grid { grid-template-columns: 1fr; } }

    /* Pleine largeur */
    .full-width{ grid-column: 1 / -1; }

    /* Badges de colonne gauche */
    .vehicule-badge{ font-weight:800; color:#ef4444; letter-spacing:.5px; text-align:left; padding-left:8px; }
    .reg-badge{ font-weight:800; color:#22c55e; letter-spacing:.5px; text-align:left; padding-left:8px; }

    /* Pharmacie et Ambu Garde : styles lisibles */
    #pharmacieTable thead th, #ambulanceGardeTable thead th{ font-size:14px }
    #pharmacieTable .pharm-nom input{ font-size:16px; font-weight:800; }
    #pharmacieTable .pharm-addr textarea{ min-height:56px; font-size:14px; line-height:1.35; resize:vertical; }
    #pharmacieTable .pharm-dect input{ font-weight:700; letter-spacing:.3px; }

/* Agrandir tous les menus d√©roulants du site liste d√©roulante */
select { 
  font-size: 19px;       /* Mets 18px, 20px si tu veux plus grand */
  line-height: 1.3;
  padding: 10px 12px;
}

/* Taille des √©l√©ments de la liste (selon le navigateur) */
select option,
select optgroup { 
  font-size: 16px;
}

/* === Agrandissement g√©n√©ral des textes saisis nom de m√©decins ide ect... === */

/* Tous les champs de saisie (nom, DECT, recherche, etc.) */
input[type="text"],
input[list],
textarea {
  font-size: 17px;        /* Tu peux mettre 18px ou 20px si tu veux plus grand */
  padding: 10px 12px;
}

/* Tous les menus d√©roulants */
select {
  font-size: 20px;
  padding: 10px 12px;
}

/* Les options dans les menus (selon le navigateur) */
select option,
select optgroup {
  font-size: 17px;
}

/* === Am√©lioration de la lisibilit√© des √©tiquettes de service Infos fixes (rappels) === */
.td-left {
  font-size: 18px;          /* üîπ taille du texte des services */
  font-weight: 700;         /* üîπ gras pour une meilleure lecture */
  color: #f1f5f9;           /* üîπ blanc lisible sur fond sombre */
  letter-spacing: 0.5px;    /* üîπ a√©ration du texte */
  text-shadow: 0 1px 1px rgba(0,0,0,0.3); /* üîπ l√©ger relief pour contraste */
  padding-right: 10px;
}

/* === Agrandir le texte des services dans le tableau M√©decins === */
#medecinsTable td select.service-select {
  font-size: 66px;        /* üîπ augmente la taille (mets 18px si tu veux encore plus grand) */
  font-weight: 600;       /* üîπ un peu plus gras pour la lisibilit√© */
  padding: 8px 10px;      /* üîπ plus d‚Äôespace int√©rieur */
  color: #f1f5f9;         /* üîπ texte clair sur fond sombre */
  background: rgba(255,255,255,0.05); /* üîπ fond l√©ger */
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
}







/* === Style personnalis√© pour le tableau des ambulance de garde  === */
#ambulanceGardeTable {
  background: rgba(0, 50, 120, 0.25); /* üîπ fond bleu nuit transparent */
  border-radius: 10px;
  padding: 10px;
}

#ambulanceGardeTable th {
  background: rgba(0, 80, 160, 0.4);
  color: #fff;
}

#ambulanceGardeTable select,
#ambulanceGardeTable input {
  background: rgba(255,255,255,0.08);
  color: #f1f5f9;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
}

/* Rouge pour les badges N1 / N2 (r√©gulateurs nuit) */
#regulateurNuitTable .reg-badge{
  color: #ef4444;          /* texte rouge vif */
  font-weight: 800;
}

/* (Optionnel) pastille rouge avec fond */
#regulateurNuitTable .reg-badge.pill,
#regulateurNuitTable .reg-badge.pastille{
  color: #fff;
  background: #dc2626;
  border: 1px solid rgba(255,255,255,.2);
  padding: 2px 8px;
  border-radius: 10px;
}


/* Agrandir l‚Äô√©tiquette Service (table M√©decins) */
#medecinTable .service-badge{
  font-size: 18px;          /* ‚Üê augmente si tu veux (20px, 22px‚Ä¶) */
  font-weight: 700;
  padding: 6px 12px;        /* √©tiquette plus grande */
  border-radius: 10px;
  display: inline-block;    /* pour que padding/arrondi s‚Äôappliquent bien */
  min-width: 160px;         /* largeur mini pour une belle pastille */
  text-align: center;

  /* style visuel (optionnel) */
  background: rgba(99,102,241,.22);
  border: 1px solid rgba(99,102,241,.45);
  color: #fff;
}

/* (D√©j√† fait mais on remet pour r√©duire l‚Äôespace des DECT) */
#medecinTable td { padding: 6px 8px; }
#medecinTable input[type="text"]{
  width: 120px;             /* ajuste 100‚Äì140px selon ton besoin */
  font-size: 16px;
  font-weight: 600;
  text-align: center;
}












  </style>
</head>
<body>
  <div class="header">
    <h1>Tableau de Garde ‚Äî H√¥pital</h1>
    <div id="date"></div>
  </div>

  <div class="sync-bar">
    <span class="dot idle" id="syncDot" title="√âtat sync"></span>
    <span id="syncText">Pr√™t</span>
    <span id="lastSaved" style="opacity:.7"></span>
    <span style="opacity:.7">| Cl√© du jour : <strong id="dayKey"></strong></span>
  </div>

  <div class="toolbar">
    <button id="forceSaveBtn" class="secondary">üíæ Enregistrer maintenant</button>
    <button id="newDayBtn" class="secondary">üìÖ Nouvelle journ√©e</button>
    <button id="clearDayBtn" class="danger">üßπ Vider la journ√©e</button>
  </div>

  <!-- ======== GRILLE PRINCIPALE ======== -->
  <div class="container">
    <!-- COLONNE GAUCHE -->
    <div class="card tight">
      <div class="section-header">M√©decins</div>
      <table id="medecinTable">
        <thead>
          <tr>
            <th>Nom (saisie libre + suggestions)</th>
            <th>Service</th>
            <th>DECT</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input list="medecinsList" placeholder="Ex. Dr Dupont" /></td>
            <td><span class="service-badge">‚Äî</span></td>
            <td><input type="text" placeholder="DECT"></td>
            <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>
      <div class="actions" style="margin-top:8px">
        <button onclick="addMedecinRow()">‚ûï Ajouter un m√©decin</button>
      </div>

      <div class="section-header" style="margin-top:12px">Infos fixes (rappels)</div>
      <table>
        <thead><tr><th>Libell√©</th><th>Num√©ro / DECT</th></tr></thead>
        <tbody>
          <tr><td class="td-left">IOA jour</td><td><span class="tag">7658</span></td></tr>
          <tr><td class="td-left">IOA Nuit</td><td><span class="tag">7659</span></td></tr>
          <tr><td class="td-left">Cardiologie</td><td><span class="tag">12703</span></td></tr>
          <tr><td class="td-left">Neuro-Vasculaire</td><td><span class="tag">12676</span></td></tr>
          <tr><td class="td-left">P√©diatrie</td><td><span class="tag">7665</span></td></tr>
          <tr><td class="td-left">Radio / IRM</td><td><span class="tag">‚Äî</span></td></tr>

          <tr class="title-row"><th colspan="2" style="text-align:left;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#dbeafe;padding:8px 10px;">‚¨áÔ∏è SMUR PRIMAIRE</th></tr>
          <tr><td class="td-left">M√©decin Primaire</td><td><span class="tag j">J 7578</span><span class="tag n">N 7579</span></td></tr>
          <tr><td class="td-left">IDE Primaire</td><td><span class="tag j">J 7572</span><span class="tag n">N 7573</span></td></tr>
          <tr><td class="td-left">Ambulancier Primaire</td><td><span class="tag j">J 7570</span><span class="tag n">N 7571</span></td></tr>
          
<tr class="title-row"><th colspan="2" style="text-align:left;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#dbeafe;padding:8px 10px;">‚¨áÔ∏è SMUR SECONDAIRE</th></tr>
          <tr><td class="td-left">M√©decin Secondaire</td><td><span class="tag j">J 7580</span><span class="tag n">N 7581</span></td></tr>
          <tr><td class="td-left">IDE Secondaire 9h-21h</td><td><span class="tag j">J 7576</span><span class="tag n">N 7577</span></td></tr>
          <tr><td class="td-left">Ambulancier Secondaire</td><td><span class="tag j">J 7574</span><span class="tag n">N 7575</span></td></tr>

<tr class="title-row"><th colspan="2" style="text-align:left;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#dbeafe;padding:8px 10px;">‚¨áÔ∏è INFOS </th></tr>
          <tr><td class="td-left">Rien √† signaler </td><td><span class="tag j"></span><span class="tag n"></span></td></tr>
        
        </tbody>
      </table>
    </div>

    <!-- COLONNE DROITE (haut) : SMUR + R√©gulateurs -->
    <div>
      <div class="right-grid">
        <div class="board">
          <div class="section-header">SMUR Primaire</div>
          <table id="smurPrimaireTable">
            <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><input type="text" placeholder="Nom"></td>
                <td><input type="text" placeholder="DECT"></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRow(this)">Ajouter une ligne</button></div>
        </div>

        <div class="board">
          <div class="section-header">SMUR Secondaire</div>
          <table id="smurSecondaireTable">
            <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><input type="text" placeholder="Nom"></td>
                <td><input type="text" placeholder="DECT"></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRow(this)">Ajouter une ligne</button></div>
        </div>

        <div class="board">
          <div class="section-header">R√©gulateur ‚Äî Jour</div>
          <table id="regulateurJourTable">
            <thead><tr><th style="text-align:left;width:72px"></th><th>Nom</th><th>DECT</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="board">
          <div class="section-header">R√©gulateur ‚Äî Nuit</div>
          <table id="regulateurNuitTable">
            <thead><tr><th style="text-align:left;width:72px"></th><th>Nom</th><th>DECT</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- üöë Ambulance de Garde ‚Äî pleine largeur sous r√©gulateurs -->
      <div class="board full-width" style="margin-top:12px">
        <div class="section-header">Ambulance de Garde</div>
        <table id="ambulanceGardeTable">
          <thead>
            <tr>
              <th style="text-align:left;width:72px"></th>
              <th>Nom</th>
              <th>DECT</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Bas de colonne droite : 4 tableaux restants -->
      <div class="lower-grid">
        <!-- MRL (d√©sormais dynamique) -->
        <div class="board">
          <div class="section-header">M√©decin R√©gulateur Lib√©ral 15B</div>
          <table id="regulLiberalTable">
            <thead><tr><th>M√©decin</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><select class="mrl-nom"></select></td>
                <td><input class="mrl-dect" type="text" placeholder="DECT" /></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
              <tr>
                <td><select class="mrl-nom"></select></td>
                <td><input class="mrl-dect" type="text" placeholder="DECT" /></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRowTo('regulLiberalTable')">Ajouter un m√©decin lib√©ral</button></div>
        </div>

        <!-- Administrateur de Garde (datalist) -->
        <div class="board">
          <div class="section-header">Administrateur de Garde</div>
          <table id="administrateurTable">
            <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><input class="admin-nom" list="adminsList" placeholder="Commencez √† taper‚Ä¶"/></td>
                <td><input class="admin-dect" type="text" placeholder="DECT" /></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRowTo('administrateurTable')">Ajouter une ligne</button></div>
        </div>

        <!-- Ambulance de Sortie -->
        <div class="board">
          <div class="section-header">Ambulance de Sortie</div>
          <table id="ambulanceSortieTable">
            <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><select></select></td>
                <td><input type="text" placeholder="DECT"></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRowTo('ambulanceSortieTable')">Ajouter une ligne</button></div>
        </div>

        <!-- Ambulance de GHT -->
        <div class="board">
          <div class="section-header">Ambulance de GHT</div>
          <table id="ambulanceGHTTable">
            <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
            <tbody>
              <tr>
                <td><select></select></td>
                <td><input type="text" placeholder="DECT"></td>
                <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
              </tr>
            </tbody>
          </table>
          <div class="actions"><button onclick="addRowTo('ambulanceGHTTable')">Ajouter une ligne</button></div>
        </div>
      </div>
    </div>

    <!-- ===== Pharmacie de Garde ‚Äî PLEIN LARGEUR ===== -->
    <div class="card full-width" style="margin-top:12px">
      <div class="section-header">Pharmacie de Garde</div>
      <table id="pharmacieTable">
        <thead>
          <tr>
            <th style="width:45%; text-align:left">Nom de la pharmacie</th>
            <th style="width:40%; text-align:left">Adresse (rue, CP, ville)</th>
            <th style="width:10%;">DECT / Tel</th>
            <th style="width:5%;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="pharm-nom"><input type="text" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶"></td>
            <td class="pharm-addr"><textarea placeholder="12 rue de la Sant√©, 18000 Bourges"></textarea></td>
            <td class="pharm-dect"><input type="text" placeholder="09 00 00 00 00"></td>
            <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>
      <div class="actions" style="margin-top:10px"><button onclick="addPharmacieRow()">Ajouter une pharmacie</button></div>
    </div>
  </div>
  <!-- ======== /GRILLE ======== -->

  <!-- LISTES de suggestions -->
  <datalist id="medecinsList">
    <!-- R√©a -->
    <option value="Dr Vaz"><option value="Dr Hamizi"><option value="Dr Kinda">
    <option value="Dr Voellmy"><option value="Dr Njatomalala"><option value="Dr Chabbi">
    <option value="Dr Mortreux"><option value="Dr Chedjieu"><option value="Dr Rey">
    <!-- Cardio -->
    <option value="Dr Ricoulleau"><option value="Dr Heurtebise"><option value="Dr Laporal">
    <option value="Dr Jnifene"><option value="Dr Akiel"><option value="Dr Guenal">
    <option value="Dr Didot"><option value="Dr Brathier"><option value="Dr Dechery">
    <option value="Dr Tabat"><option value="Dr Lounthone"><option value="Dr El Idrisse">
    <option value="Dr Lemrini"><option value="Dr Seaux"><option value="Dr Athmani"><option value="Dr Chesnoy">
    <!-- Neuro-Vasc -->
    <option value="Dr Maiga"><option value="Dr Phan"><option value="Dr Chabbine">
    <option value="Dr Profiroiu"><option value="Dr Fanorena">
    <!-- P√©diatre -->
    <option value="Dr Dai Tometin"><option value="Dr Ayaz"><option value="Dr Hefteh">
    <option value="Dr Benzid"><option value="Dr Gaisne"><option value="Dr Gatti">
    <option value="Dr Ikomba"><option value="Dr Tresor"><option value="Dr Benhocine">
    <option value="Dr Toronga"><option value="Dr Mvogo"><option value="Dr Taylor">
    <option value="Dr Chatue"><option value="Dr Torona">
    <!-- Radio/IRM -->
    <option value="Dr Bello"><option value="Dr Chawa"><option value="Dr IMADI">
    <option value="Dr Gnonwa"><option value="Dr Coatrieux"><option value="Dr Bouchibane">
    <option value="Dr Adjimabou"><option value="Dr Soumo"><option value="Dr Didenjou">
  </datalist>

  <datalist id="adminsList">
    <option value="Apert Mme"><option value="Aulibert Mme"><option value="Benoist M.">
    <option value="Descouts Mme"><option value="Dhorbait Mme"><option value="Fauquembergue M.">
    <option value="Halin M."><option value="Hunault M."><option value="Le Heiget M.">
    <option value="Le tarnec Mme"><option value="Mahut M."><option value="Mercier M.">
    <option value="Osten Mme"><option value="Paoletti - Bes Mme"><option value="Perier Mme">
    <option value="Tomatis Mme"><option value="Vigneron Mme"><option value="Vo Dinh M.">
  </datalist>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDG8Tjus5no-pJpmd3tOwydo-QY8ERhH8Y",
      authDomain: "tabgarde-16180.firebaseapp.com",
      databaseURL: "https://tabgarde-16180-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tabgarde-16180",
      storageBucket: "tabgarde-16180.firebasestorage.app",
      messagingSenderId: "1087347813441",
      appId: "1:1087347813441:web:68c63e7203020dd114aac0",
      measurementId: "G-5KL9P8QW7J"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* === Listes fixes === */
    const VEHICULES_GARDE = ["B1","B2","B3","VZ","St amand","Nord","Est"];
    const REGULATEURS_JOUR = ["R1","R2"];
    const REGULATEURS_NUIT = ["N1","N2"];
    const MRL_OPTIONS = ["Dr Dion","Dr Masset","Dr Saudeau","Dr Lestrade","Dr Plisson","Dr Bergeret"];

    function renderAmbuOptions(selected) {
      return `
        <option ${selected==="2000"?'selected':''}>2000</option>
        <option ${selected==="Atlas"?'selected':''}>Atlas</option>
        <option ${selected==="Avaricum"?'selected':''}>Avaricum</option>
        <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
        <option ${selected==="JHL"?'selected':''}>JHL</option>
        <option ${selected==="Marquet"?'selected':''}>Marquet</option>
        <option ${selected==="Mazer"?'selected':''}>Mazer</option>
        <option ${selected==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
        <option ${selected==="Mill√©rioux"?'selected':''}>Mill√©rioux</option>
        <option ${selected==="Pinson"?'selected':''}>Pinson</option>
        <option ${selected==="VMA"?'selected':''}>VMA</option>
        <optgroup label="Ambu Vz">
          <option ${selected==="Andr√©"?'selected':''}>Andr√©</option>
          <option ${selected==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
          <option ${selected==="Petitjean"?'selected':''}>Petitjean</option>
          <option ${selected==="St Exup√©ry"?'selected':''}>St Exup√©ry</option>
          <option ${selected==="Beuze Prev"?'selected':''}>Beuze Prev</option>
          <option ${selected==="Castellois"?'selected':''}>Castellois</option>
          <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${selected==="Guillemin"?'selected':''}>Guillemin</option>
          <option ${selected==="Ligni√®res"?'selected':''}>Ligni√®res</option>
          <option ${selected==="Pasquet"?'selected':''}>Pasquet</option>
          <option ${selected==="St Amand"?'selected':''}>St Amand</option>
          <option ${selected==="Savignat"?'selected':''}>Savignat</option>
          <option ${selected==="JHL"?'selected':''}>JHL</option>
          <option ${selected==="Marquet"?'selected':''}>Marquet</option>
          <option ${selected==="Mill√©rioux"?'selected':''}>Mill√©rioux</option>
          <option ${selected==="Auger"?'selected':''}>Auger</option>
          <option ${selected==="Bengy"?'selected':''}>Bengy</option>
          <option ${selected==="Vall√©e de l'Aubois"?'selected':''}>Vall√©e de l'Aubois</option>
          <option ${selected==="Beuze Pr√©veranges"?'selected':''}>Beuze Pr√©veranges</option>
          <option ${selected==="Castellois"?'selected':''}>Castellois</option>
          <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${selected==="Guillemin"?'selected':''}>Guillemin</option>
          <option ${selected==="Ligni√®res"?'selected':''}>Ligni√®res</option>
          <option ${selected==="Pasquet"?'selected':''}>Pasquet</option>
          <option ${selected==="Dr Autre"?'selected':''}>Dr Autre</option>
        </optgroup>
      `;
    }
    const renderMRLOptions = (selected)=> MRL_OPTIONS.map(n=>`<option ${selected===n?'selected':''}>${n}</option>`).join('');
    function renderRegOptions(selected){
      const list = [
        "Dr Agbessi 7886","Dr Arar 8216","Dr Belghalem","Dr Campet","Dr Carlos 6497","Dr Chereau",
        "Dr Chomono","Dr Cochonneau 7895","Dr Dechery 7309","Dr Dorion 7313","Dr Gonzales de Linares",
        "Dr Hibon Ricard","Dr Labbens 7350","Dr Mazuir 7366","Dr Meyer 6412","Dr Michel","Dr Mirat",
        "Dr Nasalan 7320","Dr Nuskovski","Dr Paris","Dr Rabec","Dr Shehata","Dr Santiago","Dr Sokpoh"
      ];
      return list.map(n => `<option ${selected===n?'selected':''}>${n}</option>`).join('');
    }

    // Helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const dayKeyEl = $('#dayKey'), syncDot=$('#syncDot'), syncText=$('#syncText'), lastSaved=$('#lastSaved');
    const todayKey = () => new Date().toISOString().slice(0,10);
    let currentKey = localStorage.getItem('gardeDayKey') || todayKey();
    dayKeyEl.textContent = currentKey;
    const dataRef = () => ref(db, `tableauGarde/${currentKey}`);
    const setSaving = (b)=>{ if(b){syncDot.className='dot saving';syncText.textContent='Sauvegarde‚Ä¶';}else{syncDot.className='dot online';syncText.textContent='Synchronis√©';lastSaved.textContent=`‚Ä¢ ${new Date().toLocaleTimeString('fr-FR')}`;} };

    // Nom -> service
    const serviceMap = {
      "Dr Vaz":"R√©animation","Dr Hamizi":"R√©animation","Dr Kinda":"R√©animation","Dr Voellmy":"R√©animation",
      "Dr Njatomalala":"R√©animation","Dr Chabbi":"R√©animation","Dr Mortreux":"R√©animation","Dr Chedjieu":"R√©animation","Dr Rey":"R√©animation",
      "Dr Ricoulleau":"Cardio","Dr Heurtebise":"Cardio","Dr Laporal":"Cardio","Dr Jnifene":"Cardio","Dr Akiel":"Cardio","Dr Guenal":"Cardio",
      "Dr Didot":"Cardio","Dr Brathier":"Cardio","Dr Dechery":"Cardio","Dr Tabat":"Cardio","Dr Lounthone":"Cardio","Dr El Idrisse":"Cardio",
      "Dr Lemrini":"Cardio","Dr Seaux":"Cardio","Dr Athmani":"Cardio","Dr Chesnoy":"Cardio",
      "Dr Maiga":"Neuro-vasc","Dr Phan":"Neuro-vasc","Dr Chabbine":"Neuro-vasc","Dr Profiroiu":"Neuro-vasc","Dr Fanorena":"Neuro-vasc",
      "Dr Dai Tometin":"P√©diatrie","Dr Ayaz":"P√©diatrie","Dr Hefteh":"P√©diatrie","Dr Benzid":"P√©diatrie","Dr Gaisne":"P√©diatrie","Dr Gatti":"P√©diatrie",
      "Dr Ikomba":"P√©diatrie","Dr Tresor":"P√©diatrie","Dr Benhocine":"P√©diatrie","Dr Toronga":"P√©diatrie","Dr Mvogo":"P√©diatrie","Dr Taylor":"P√©diatrie",
      "Dr Chatue":"P√©diatrie","Dr Torona":"P√©diatrie",
      "Dr Bello":"Radiologie","Dr Chawa":"Radiologie","Dr IMADI":"Radiologie","Dr Gnonwa":"Radiologie","Dr Coatrieux":"Radiologie",
      "Dr Bouchibane":"Radiologie","Dr Adjimabou":"Radiologie","Dr Soumo":"Radiologie","Dr Didenjou":"Radiologie"
    };
    const inferService = (name)=> serviceMap[name?.trim()] || "‚Äî";

    /* ====== SERIALIZE ====== */
    function readTableRows(tableId, mapRow){
      const tbody = document.getElementById(tableId).querySelector('tbody');
      return Array.from(tbody.rows).map(mapRow);
    }
    function serializeAll(){
      return {
        medecins: readTableRows('medecinTable', (tr) => {
          const name = tr.cells[0].querySelector('input')?.value || '';
          const dect = tr.cells[2].querySelector('input')?.value || '';
          return { nom: name, service: inferService(name), dect };
        }),
        smurPrimaire: readTableRows('smurPrimaireTable', (tr) => ({
          nom: tr.cells[0].querySelector('input, select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        smurSecondaire: readTableRows('smurSecondaireTable', (tr) => ({
          nom: tr.cells[0].querySelector('input, select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        regulateurJour: (() => {
          const tb = document.querySelector('#regulateurJourTable tbody');
          return Array.from(tb.rows).map(tr => ({
            slot: tr.cells[0].textContent.trim(),
            nom: tr.querySelector('.rj-nom')?.value || '',
            dect: tr.querySelector('.rj-dect')?.value || ''
          }));
        })(),
        regulateurNuit: (() => {
          const tb = document.querySelector('#regulateurNuitTable tbody');
          return Array.from(tb.rows).map(tr => ({
            slot: tr.cells[0].textContent.trim(),
            nom: tr.querySelector('.rn-nom')?.value || '',
            dect: tr.querySelector('.rn-dect')?.value || ''
          }));
        })(),
        regulLiberal: readTableRows('regulLiberalTable', (tr) => ({
          nom: tr.querySelector('.mrl-nom')?.value || '',
          dect: tr.querySelector('.mrl-dect')?.value || ''
        })),
        administrateur: readTableRows('administrateurTable', (tr) => ({
          nom: tr.querySelector('.admin-nom')?.value || '',
          dect: tr.querySelector('.admin-dect')?.value || ''
        })),
        ambulanceGarde: (() => {
          const tbody = document.querySelector('#ambulanceGardeTable tbody');
          return Array.from(tbody.rows).map(tr => ({
            vehicule: tr.cells[0].textContent.trim(),
            nom:      tr.querySelector('.ag-nom')?.value || '',
            dect:     tr.querySelector('.ag-dect')?.value || ''
          }));
        })(),
        ambulanceSortie: readTableRows('ambulanceSortieTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        ambulanceGHT: readTableRows('ambulanceGHTTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        pharmacie: readTableRows('pharmacieTable', (tr) => ({
          nom: tr.cells[0].querySelector('input')?.value || '',
          adresse: tr.cells[1].querySelector('textarea')?.value || '',
          dect: tr.cells[2].querySelector('input')?.value || ''
        }))
      };
    }

    /* ====== RENDER/HYDRATE ====== */
    function renderRows(tbody, rows, renderCellHtmls){
      tbody.innerHTML = '';
      rows.forEach((row) => {
        const tr = tbody.insertRow();
        tr.innerHTML = renderCellHtmls(row);
      });
    }

    function hydrateAll(data){
      data = data || {};

      // M√©decins
      renderRows($('#medecinTable tbody'), data.medecins || [], (row) => `
        <td><input list="medecinsList" value="${row.nom||''}" placeholder="Ex. Dr Dupont"/></td>
        <td><span class="service-badge">${inferService(row.nom||'')}</span></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // SMUR
      renderRows($('#smurPrimaireTable tbody'), data.smurPrimaire || [], (row)=>`
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
      renderRows($('#smurSecondaireTable tbody'), data.smurSecondaire || [], (row)=>`
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // R√©gulateurs
      renderRows(document.querySelector('#regulateurJourTable tbody'),
        REGULATEURS_JOUR.map(slot => {
          const found = (data.regulateurJour || []).find(r => (r.slot||'') === slot) || {};
          return { slot, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row)=>`
          <td class="reg-badge">${row.slot}</td>
          <td><select class="rj-nom">${renderRegOptions(row.nom)}</select></td>
          <td><input class="rj-dect" type="text" placeholder="DECT" value="${row.dect||''}"/></td>
        `
      );
      renderRows(document.querySelector('#regulateurNuitTable tbody'),
        REGULATEURS_NUIT.map(slot => {
          const found = (data.regulateurNuit || []).find(r => (r.slot||'') === slot) || {};
          return { slot, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row)=>`
          <td class="reg-badge">${row.slot}</td>
          <td><select class="rn-nom">${renderRegOptions(row.nom)}</select></td>
          <td><input class="rn-dect" type="text" placeholder="DECT" value="${row.dect||''}"/></td>
        `
      );

      // M√©decin R√©gulateur Lib√©ral (dynamique)
      const mrlRows = (data.regulLiberal && data.regulLiberal.length) ? data.regulLiberal : [{},{}];
      renderRows($('#regulLiberalTable tbody'), mrlRows, (row)=>`
        <td><select class="mrl-nom">${renderMRLOptions(row.nom||'')}</select></td>
        <td><input class="mrl-dect" type="text" placeholder="DECT" value="${row.dect||''}"/></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Administrateur de Garde (datalist)
      renderRows($('#administrateurTable tbody'), data.administrateur || [], (row)=>`
        <td><input class="admin-nom" list="adminsList" value="${row.nom||''}" placeholder="Commencez √† taper‚Ä¶"/></td>
        <td><input class="admin-dect" type="text" value="${row.dect||''}" placeholder="DECT"/></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Ambulance de GARDE ‚Äî lignes fixes
      renderRows(document.querySelector('#ambulanceGardeTable tbody'),
        VEHICULES_GARDE.map(v => {
          const found = (data.ambulanceGarde || []).find(r => (r.vehicule||'') === v) || {};
          return { vehicule: v, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row) => `
          <td class="vehicule-badge">${row.vehicule}</td>
          <td><select class="ag-nom">${renderAmbuOptions(row.nom||'')}</select></td>
          <td><input class="ag-dect" type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        `
      );

      // Ambulances dynamiques
      renderRows($('#ambulanceSortieTable tbody'), data.ambulanceSortie || [], (row)=>`
        <td><select>${renderAmbuOptions(row.nom||'')}</select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
      renderRows($('#ambulanceGHTTable tbody'), data.ambulanceGHT || [], (row)=>`
        <td><select>${renderAmbuOptions(row.nom||'')}</select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Pharmacie
      renderRows($('#pharmacieTable tbody'), data.pharmacie || [], (row)=>`
        <td class="pharm-nom"><input type="text" value="${row.nom||''}" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶" /></td>
        <td class="pharm-addr"><textarea placeholder="Adresse (rue, CP, ville)">${row.adresse||''}</textarea></td>
        <td class="pharm-dect"><input type="text" value="${row.dect||''}" placeholder="09 00 00 00 00" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
    }

    /* ====== SAVE / LOAD ====== */
    let debounceTimer = null;
    const DEBOUNCE_MS = 1200;
    let skipNextUpdate = false;

    function scheduleSave(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(saveAll, DEBOUNCE_MS); setSaving(true); }
    async function saveAll(){ const data = serializeAll(); skipNextUpdate = true; await set(dataRef(), data); setSaving(false); }

    function loadAndListen(){
      onValue(dataRef(), (snap)=>{
        if (skipNextUpdate){ skipNextUpdate = false; return; }
        hydrateAll(snap.val() || {});
        wireAutoSave();
        setSaving(false);
      });
    }

    /* ====== UI WIRING ====== */
    function wireAutoSave(){
      // M√©decins : badge service live
      $$('#medecinTable tbody input[list="medecinsList"]').forEach(inp=>{
        const update = () => {
          inp.closest('tr').cells[1].querySelector('.service-badge').textContent = inferService(inp.value);
          scheduleSave();
        };
        inp.oninput = update; inp.onchange = update;
      });
      $$('input, select, textarea').forEach(el=>{ el.oninput = scheduleSave; el.onchange = scheduleSave; });
    }

    // Raccourci CTRL/CMD+S
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAll(); }
    });

    // Toolbar
    document.getElementById('forceSaveBtn').addEventListener('click', saveAll);
    document.getElementById('newDayBtn').addEventListener('click', ()=>{
      currentKey = todayKey(); localStorage.setItem('gardeDayKey', currentKey); dayKeyEl.textContent = currentKey;
      hydrateAll({}); saveAll(); loadAndListen();
    });
    document.getElementById('clearDayBtn').addEventListener('click', async ()=>{
      if (confirm('Effacer toutes les donn√©es de la journ√©e ?')){ await remove(dataRef()); hydrateAll({}); saveAll(); }
    });

    // Actions g√©n√©riques
    window.deleteRow = (button)=>{ button.closest('tr').remove(); scheduleSave(); }

    // Ajout SMUR (d√©tecte le tableau)
    window.addRow = (button)=>{
      const wrap = button.closest('.board'); const tbody = wrap.querySelector('tbody');
      const tableId = wrap.querySelector('table')?.id || '';
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td><input type="text" placeholder="Nom" /></td>
        <td><input type="text" placeholder="DECT" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave(); scheduleSave();
    }

    // Ajout cibl√© (MRL, Admin, Ambu Sortie, GHT)
    window.addRowTo = function(tableId){
      const tbody = document.querySelector(`#${tableId} tbody`);
      if (!tbody) return;
      const tr = tbody.insertRow();
      if (tableId === 'regulLiberalTable'){
        tr.innerHTML = `
          <td><select class="mrl-nom">${renderMRLOptions('')}</select></td>
          <td><input class="mrl-dect" type="text" placeholder="DECT" /></td>
          <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      } else if (tableId === 'administrateurTable'){
        tr.innerHTML = `
          <td><input class="admin-nom" list="adminsList" placeholder="Commencez √† taper‚Ä¶"/></td>
          <td><input class="admin-dect" type="text" placeholder="DECT" /></td>
          <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      } else {
        tr.innerHTML = `
          <td><select>${renderAmbuOptions('')}</select></td>
          <td><input type="text" placeholder="DECT" /></td>
          <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      }
      wireAutoSave(); scheduleSave();
    }

    // Ajouter m√©decin
    window.addMedecinRow = function () {
      const tbody = document.querySelector('#medecinTable tbody');
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td><input list="medecinsList" placeholder="Ex. Dr Dupont" /></td>
        <td><span class="service-badge">‚Äî</span></td>
        <td><input type="text" placeholder="DECT" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `;
      const nameInput = tr.querySelector('input[list="medecinsList"]');
      const badge = tr.cells[1].querySelector('.service-badge');
      const updateService = () => { badge.textContent = inferService(nameInput.value); scheduleSave(); };
      nameInput.addEventListener('input', updateService);
      nameInput.addEventListener('change', updateService);
      wireAutoSave(); scheduleSave();
    }

    // Pharmacie : ajouter ligne
    window.addPharmacieRow = function(){
      const tbody = document.querySelector('#pharmacieTable tbody');
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td class="pharm-nom"><input type="text" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶"/></td>
        <td class="pharm-addr"><textarea placeholder="Adresse (rue, CP, ville)"></textarea></td>
        <td class="pharm-dect"><input type="text" placeholder="09 00 00 00 00"/></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave(); scheduleSave();
    }

    // Boot
    document.getElementById('date').textContent =
      new Date().toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

    function firstLoad(){
      onValue(dataRef(), (snap)=>{
        hydrateAll(snap.val() || {});
        // inject options si vide
        document.querySelectorAll('#regulLiberalTable .mrl-nom').forEach(sel=>{ if(!sel.innerHTML.trim()) sel.innerHTML = renderMRLOptions(''); });
        document.querySelectorAll('#ambulanceSortieTable select, #ambulanceGHTTable select, #ambulanceGardeTable .ag-nom')
          .forEach(sel=>{ if (!sel.innerHTML.trim()) sel.innerHTML = renderAmbuOptions(''); });
        wireAutoSave();
        setSaving(false);
      }, { onlyOnce:true });

      loadAndListen();
    }
    firstLoad();
  </script>

  <footer class="footer" style="text-align:center;color:#9ca3af;font-size:14px;padding:12px 0;border-top:1px solid rgba(255,255,255,.1);margin-top:16px;background:rgba(255,255,255,.02);">
    ¬© 2025 Mat√©o CALLEJA ‚Äî Tous droits r√©serv√©s
  </footer>
</body>
</html>
