<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tableau de Garde - H√¥pital (Firebase)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1226aa; --muted:#94a3b8; --text:#e2e8f0;
      --accent:#2563eb; --accent2:#7c3aed; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --shadow: 0 8px 30px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 900px at 20% -10%, #1e293b 0%, #0f172a 60%);
    }
    .header{ padding:20px 12px; text-align:center;
      background: linear-gradient(135deg, rgba(37,99,235,.35), rgba(124,58,237,.30));
      border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px);
    }
    .header h1{margin:0; font-size:26px}
    #date{opacity:.85; margin-top:6px; font-size:13px}

    .sync-bar{display:flex; gap:10px; align-items:center; justify-content:center; font-size:13px; padding:8px 10px; opacity:.9}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.idle{background:#64748b}.dot.saving{background:var(--warn);animation:pulse 1.1s infinite}.dot.online{background:var(--ok)}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.22)}100%{transform:scale(1)}}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; padding:10px}
    button{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer;
      backdrop-filter: blur(6px); transition:.2s;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.25)}
    button.secondary{border-color: rgba(37,99,235,.4)}
    button.danger{border-color: rgba(239,68,68,.4)}

    /* Grille : colonne gauche + zone droite (2 colonnes) */
    .container{display:grid; grid-template-columns: 1.1fr 1.9fr; gap:18px; padding:16px}
    @media (max-width:1100px){ .container{grid-template-columns:1fr} }

    .card{background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px}
    .section-header{font-weight:700; letter-spacing:.3px; margin:2px 0 10px; text-align:center; color:#dbeafe}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    th,td{padding:10px 10px; text-align:center}
    thead th{background: linear-gradient(180deg, rgba(37,99,235,.30), rgba(124,58,237,.18)); border-bottom:1px solid rgba(255,255,255,.12); font-size:13px}
    tbody td{border-top:1px solid rgba(255,255,255,.06)}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; outline: none;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--text);
    }
    input::placeholder, textarea::placeholder{color:#94a3b866}
    .actions{display:flex; gap:6px; justify-content:center}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(37,99,235,.22); border:1px solid rgba(37,99,235,.5); font-size:12px}
    .service-badge{display:inline-block; padding:2px 7px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06)}
    .td-left{text-align:left}
    .tight table tbody td{padding-top:6px; padding-bottom:6px}

    /* Zone droite en 2 colonnes */
    .right-grid { display:grid; grid-template-columns: repeat(2, minmax(340px, 1fr)); gap:18px; align-items:start; }
    .board { background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; }
    .board .section-header { margin-bottom:8px; }
    .board .actions > button { width:100%; }
    @media (max-width: 1200px) { .right-grid { grid-template-columns: 1fr; } }

    /* Badges √† gauche */
    .vehicule-badge{ font-weight:800; color:#ef4444; letter-spacing:.5px; text-align:left; padding-left:8px; }
    .reg-badge{ font-weight:800; color:#22c55e; letter-spacing:.5px; text-align:left; padding-left:8px; }

    /* === Pharmacie : plein-largeur sous la grille === */
    .full-width{ grid-column: 1 / -1; }
    #pharmacieTable thead th{ font-size:14px }
    #pharmacieTable .pharm-nom input{ font-size:16px; font-weight:800; }
    #pharmacieTable .pharm-addr textarea{ min-height:56px; font-size:14px; line-height:1.35; resize:vertical; }
    #pharmacieTable .pharm-dect input{ font-weight:700; letter-spacing:.3px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Tableau de Garde ‚Äî H√¥pital</h1>
    <div id="date"></div>
  </div>

  <div class="sync-bar">
    <span class="dot idle" id="syncDot" title="√âtat sync"></span>
    <span id="syncText">Pr√™t</span>
    <span id="lastSaved" style="opacity:.7"></span>
    <span style="opacity:.7">| Cl√© du jour : <strong id="dayKey"></strong></span>
  </div>

  <div class="toolbar">
    <button id="forceSaveBtn" class="secondary">üíæ Enregistrer maintenant</button>
    <button id="newDayBtn" class="secondary">üìÖ Nouvelle journ√©e</button>
    <button id="clearDayBtn" class="danger">üßπ Vider la journ√©e</button>
  </div>

  <!-- ======== GRILLE PRINCIPALE ======== -->
  <div class="container">
    <!-- COLONNE GAUCHE -->
    <div class="card tight">
      <div class="section-header">M√©decins</div>
      <table id="medecinTable">
        <thead>
          <tr>
            <th>Nom (saisie libre + suggestions)</th>
            <th>Service</th>
            <th>DECT</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input list="medecinsList" placeholder="Ex. Dr Dupont" /></td>
            <td><span class="service-badge">‚Äî</span></td>
            <td><input type="text" placeholder="DECT"></td>
            <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>
      <div class="actions" style="margin-top:8px">
        <button onclick="addMedecinRow()">‚ûï Ajouter un m√©decin</button>
      </div>

      <div class="section-header" style="margin-top:12px">Infos fixes (rappels)</div>
      <table>
        <thead><tr><th>Libell√©</th><th>Num√©ro / DECT</th></tr></thead>
        <tbody>
         <tbody>
  <tr><td class="td-left">IOA jour</td><td><span class="tag">7658</span></td></tr>
  <tr><td class="td-left">Cardiologie</td><td><span class="tag">12703</span></td></tr>
  <tr><td class="td-left">Neuro-Vasculaire</td><td><span class="tag">12676</span></td></tr>
  <tr><td class="td-left">P√©diatrie</td><td><span class="tag">7665</span></td></tr>
  <tr><td class="td-left">Radio / IRM</td><td><span class="tag">‚Äî</span></td></tr>

  <!-- Titre SMUR PRIMAIRE -->
  <tr class="title-row"><th colspan="2">‚¨áÔ∏è SMUR PRIMAIRE</th></tr>
  <tr><td class="td-left">M√©decin Primaire</td>
      <td><span class="tag">J 7578</span><span class="tag" style="margin-left:6px">N 7579</span></td></tr>
  <tr><td class="td-left">IDE Primaire 7h-19h / 19h-7h</td>
      <td><span class="tag">J 7572</span><span class="tag" style="margin-left:6px">N 7573</span></td></tr>
  <tr><td class="td-left">Ambulancier Primaire</td>
      <td><span class="tag">J 7570</span><span class="tag" style="margin-left:6px">N 7571</span></td></tr>

  <!-- Titre SMUR SECONDAIRE -->
  <tr class="title-row"><th colspan="2">‚¨áÔ∏è SMUR SECONDAIRE</th></tr>
  <tr><td class="td-left">M√©decin Secondaire</td>
      <td><span class="tag">J 7580</span><span class="tag" style="margin-left:6px">N 7581</span></td></tr>
  <tr><td class="td-left">IDE Secondaire 9h-21h / 21h-9h</td>
      <td><span class="tag">J 7576</span><span class="tag" style="margin-left:6px">N 7577</span></td></tr>
  <tr><td class="td-left">Ambulancier Secondaire</td>
      <td><span class="tag">J 7574</span><span class="tag" style="margin-left:6px">N 7575</span></td></tr>
</tbody>


        </tbody>
      </table>
    </div>

    <!-- ZONE DROITE EN 2 COLONNES -->
    <div class="right-grid">
      <div class="board">
        <div class="section-header">SMUR Primaire</div>
        <table id="smurPrimaireTable">
          <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
          <tbody>
            <tr>
              <td><input type="text" placeholder="Nom"></td>
              <td><input type="text" placeholder="DECT"></td>
              <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions"><button onclick="addRow(this)">Ajouter une ligne</button></div>
      </div>

      <div class="board">
        <div class="section-header">SMUR Secondaire</div>
        <table id="smurSecondaireTable">
          <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
          <tbody>
            <tr>
              <td><input type="text" placeholder="Nom"></td>
              <td><input type="text" placeholder="DECT"></td>
              <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions"><button onclick="addRow(this)">Ajouter une ligne</button></div>
      </div>

      <!-- R√©gulateur ‚Äî Jour -->
      <div class="board">
        <div class="section-header">R√©gulateur ‚Äî Jour</div>
        <table id="regulateurJourTable">
          <thead><tr><th style="text-align:left;width:72px"></th><th>Nom</th><th>DECT</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- R√©gulateur ‚Äî Nuit -->
      <div class="board">
        <div class="section-header">R√©gulateur ‚Äî Nuit</div>
        <table id="regulateurNuitTable">
          <thead><tr><th style="text-align:left;width:72px"></th><th>Nom</th><th>DECT</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ambulance de Garde (fixes) -->
      <div class="board">
        <div class="section-header">Ambulance de Garde</div>
        <table id="ambulanceGardeTable">
          <thead>
            <tr>
              <th style="text-align:left;width:72px"></th>
              <th>Nom</th>
              <th>DECT</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ambulance de Sortie + Ambulance de GHT -->
      <div class="board">
        <div class="section-header">Ambulance de Sortie</div>
        <table id="ambulanceSortieTable">
          <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
          <tbody>
            <tr>
              <td><select></select></td>
              <td><input type="text" placeholder="DECT"></td>
              <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions" style="margin-bottom:14px">
          <button onclick="addRowTo('ambulanceSortieTable')">Ajouter une ligne</button>
        </div>

        <div class="section-header" style="margin-top:0">Ambulance de GHT</div>
        <table id="ambulanceGHTTable">
          <thead><tr><th>Nom</th><th>DECT</th><th>Action</th></tr></thead>
          <tbody>
            <tr>
              <td><select></select></td>
              <td><input type="text" placeholder="DECT"></td>
              <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions">
          <button onclick="addRowTo('ambulanceGHTTable')">Ajouter une ligne</button>
        </div>
      </div>
    </div>

    <!-- ===== Pharmacie de Garde ‚Äî PLEIN LARGEUR SOUS LA GRILLE ===== -->
    <div class="card full-width">
      <div class="section-header">Pharmacie de Garde</div>
      <table id="pharmacieTable">
        <thead>
          <tr>
            <th style="width:45%; text-align:left">Nom de la pharmacie</th>
            <th style="width:40%; text-align:left">Adresse (rue, CP, ville)</th>
            <th style="width:10%;">DECT / Tel</th>
            <th style="width:5%;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="pharm-nom"><input type="text" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶"></td>
            <td class="pharm-addr"><textarea placeholder="12 rue de la Sant√©, 18000 Bourges"></textarea></td>
            <td class="pharm-dect"><input type="text" placeholder="09 00 00 00 00"></td>
            <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>
      <div class="actions" style="margin-top:10px"><button onclick="addPharmacieRow()">Ajouter une pharmacie</button></div>
    </div>
  </div>
  <!-- ======== /GRILLE ======== -->

  <!-- Datalists -->
  <datalist id="medecinsList">
    <!-- R√©a -->
    <option value="Dr Vaz"><option value="Dr Hamizi"><option value="Dr Kinda">
    <option value="Dr Voellmy"><option value="Dr Njatomalala"><option value="Dr Chabbi">
    <option value="Dr Mortreux"><option value="Dr Chedjieu"><option value="Dr Rey">
    <!-- Cardio -->
    <option value="Dr Ricoulleau"><option value="Dr Heurtebise"><option value="Dr Laporal">
    <option value="Dr Jnifene"><option value="Dr Akiel"><option value="Dr Guenal">
    <option value="Dr Didot"><option value="Dr Brathier"><option value="Dr Dechery">
    <option value="Dr Tabat"><option value="Dr Lounthone"><option value="Dr El Idrisse">
    <option value="Dr Lemrini"><option value="Dr Seaux"><option value="Dr Athmani"><option value="Dr Chesnoy">
    <!-- Neuro-Vasc -->
    <option value="Dr Maiga"><option value="Dr Phan"><option value="Dr Chabbine">
    <option value="Dr Profiroiu"><option value="Dr Fanorena">
    <!-- P√©diatre -->
    <option value="Dr Dai Tometin"><option value="Dr Ayaz"><option value="Dr Hefteh">
    <option value="Dr Benzid"><option value="Dr Gaisne"><option value="Dr Gatti">
    <option value="Dr Ikomba"><option value="Dr Tresor"><option value="Dr Benhocine">
    <option value="Dr Toronga"><option value="Dr Mvogo"><option value="Dr Taylor">
    <option value="Dr Chatue"><option value="Dr Torona">
    <!-- Radiologues/IRM -->
    <option value="Dr Bello"><option value="Dr Chawa"><option value="Dr IMADI">
    <option value="Dr Gnonwa"><option value="Dr Coatrieux"><option value="Dr Bouchibane">
    <option value="Dr Adjimabou"><option value="Dr Soumo"><option value="Dr Didenjou">
  </datalist>

  <datalist id="regulateursList">
    <option value="Dr Agbessi 7886"><option value="Dr Arar 8216"><option value="Dr Belghalem">
    <option value="Dr Campet"><option value="Dr Carlos 6497"><option value="Dr Chereau">
    <option value="Dr Chomono"><option value="Dr Cochonneau 7895"><option value="Dr Dechery 7309">
    <option value="Dr Dorion 7313"><option value="Dr Gonzales de Linares"><option value="Dr Hibon Ricard">
    <option value="Dr Labbens 7350"><option value="Dr Mazuir 7366"><option value="Dr Meyer 6412">
    <option value="Dr Michel"><option value="Dr Mirat"><option value="Dr Nasalan 7320"><option value="Dr Nuskovski">
    <option value="Dr Paris"><option value="Dr Rabec"><option value="Dr Shehata"><option value="Dr Santiago"><option value="Dr Sokpoh">
  </datalist>

  <!-- App + Realtime Database -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDG8Tjus5no-pJpmd3tOwydo-QY8ERhH8Y",
      authDomain: "tabgarde-16180.firebaseapp.com",
      databaseURL: "https://tabgarde-16180-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tabgarde-16180",
      storageBucket: "tabgarde-16180.firebasestorage.app",
      messagingSenderId: "1087347813441",
      appId: "1:1087347813441:web:68c63e7203020dd114aac0",
      measurementId: "G-5KL9P8QW7J"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* === Listes fixes === */
    const VEHICULES_GARDE = ["B1","B2","B3","VZ","St amd","Nord","Est"];  // Ambulance de garde
    const REGULATEURS_JOUR = ["R1","R2"];
    const REGULATEURS_NUIT = ["N1","N2"];

    /* === Options des ambulances === */
    function renderAmbuOptions(selected) {
      return `
        <option ${selected==="2000"?'selected':''}>2000</option>
        <option ${selected==="Atlas"?'selected':''}>Atlas</option>
        <option ${selected==="Avaricum"?'selected':''}>Avaricum</option>
        <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
        <option ${selected==="JHL"?'selected':''}>JHL</option>
        <option ${selected==="Marquet"?'selected':''}>Marquet</option>
        <option ${selected==="Mazer"?'selected':''}>Mazer</option>
        <option ${selected==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
        <option ${selected==="Mill√©rioux"?'selected':''}>Mill√©rioux</option>
        <option ${selected==="Pinson"?'selected':''}>Pinson</option>
        <option ${selected==="VMA"?'selected':''}>VMA</option>
        <optgroup label="Ambu Vz">
          <option ${selected==="Andr√©"?'selected':''}>Andr√©</option>
          <option ${selected==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
          <option ${selected==="Petitjean"?'selected':''}>Petitjean</option>
          <option ${selected==="St Exup√©ry"?'selected':''}>St Exup√©ry</option>
          <option ${selected==="Beuze Prev"?'selected':''}>Beuze Prev</option>
          <option ${selected==="Castellois"?'selected':''}>Castellois</option>
          <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${selected==="Guillemin"?'selected':''}>Guillemin</option>
          <option ${selected==="Ligni√®res"?'selected':''}>Ligni√®res</option>
          <option ${selected==="Pasquet"?'selected':''}>Pasquet</option>
          <option ${selected==="St Amand"?'selected':''}>St Amand</option>
          <option ${selected==="Savignat"?'selected':''}>Savignat</option>
          <option ${selected==="JHL"?'selected':''}>JHL</option>
          <option ${selected==="Marquet"?'selected':''}>Marquet</option>
          <option ${selected==="Mill√©rioux"?'selected':''}>Mill√©rioux</option>
          <option ${selected==="Auger"?'selected':''}>Auger</option>
          <option ${selected==="Bengy"?'selected':''}>Bengy</option>
          <option ${selected==="Vall√©e de l'Aubois"?'selected':''}>Vall√©e de l'Aubois</option>
          <option ${selected==="Beuze Pr√©veranges"?'selected':''}>Beuze Pr√©veranges</option>
          <option ${selected==="Castellois"?'selected':''}>Castellois</option>
          <option ${selected==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${selected==="Guillemin"?'selected':''}>Guillemin</option>
          <option ${selected==="Ligni√®res"?'selected':''}>Ligni√®res</option>
          <option ${selected==="Pasquet"?'selected':''}>Pasquet</option>
          <option ${selected==="Dr Autre"?'selected':''}>Dr Autre</option>
        </optgroup>
      `;
    }

    /* === Options des r√©gulateurs === */
    function renderRegOptions(selected){
      const list = [
        "Dr Agbessi 7886","Dr Arar 8216","Dr Belghalem","Dr Campet","Dr Carlos 6497","Dr Chereau",
        "Dr Chomono","Dr Cochonneau 7895","Dr Dechery 7309","Dr Dorion 7313","Dr Gonzales de Linares",
        "Dr Hibon Ricard","Dr Labbens 7350","Dr Mazuir 7366","Dr Meyer 6412","Dr Michel","Dr Mirat",
        "Dr Nasalan 7320","Dr Nuskovski","Dr Paris","Dr Rabec","Dr Shehata","Dr Santiago","Dr Sokpoh"
      ];
      return list.map(n => `<option ${selected===n?'selected':''}>${n}</option>`).join('');
    }

    // Helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const dayKeyEl = $('#dayKey'), syncDot=$('#syncDot'), syncText=$('#syncText'), lastSaved=$('#lastSaved');
    const todayKey = () => new Date().toISOString().slice(0,10);
    let currentKey = localStorage.getItem('gardeDayKey') || todayKey();
    dayKeyEl.textContent = currentKey;
    const dataRef = () => ref(db, `tableauGarde/${currentKey}`);
    const setSaving = (b)=>{ if(b){syncDot.className='dot saving';syncText.textContent='Sauvegarde‚Ä¶';}else{syncDot.className='dot online';syncText.textContent='Synchronis√©';lastSaved.textContent=`‚Ä¢ ${new Date().toLocaleTimeString('fr-FR')}`;} };

    // Mapping nom -> service (m√©decins)
    const serviceMap = {
      "Dr Vaz":"R√©animation","Dr Hamizi":"R√©animation","Dr Kinda":"R√©animation","Dr Voellmy":"R√©animation",
      "Dr Njatomalala":"R√©animation","Dr Chabbi":"R√©animation","Dr Mortreux":"R√©animation","Dr Chedjieu":"R√©animation","Dr Rey":"R√©animation",
      "Dr Ricoulleau":"Cardio","Dr Heurtebise":"Cardio","Dr Laporal":"Cardio","Dr Jnifene":"Cardio","Dr Akiel":"Cardio","Dr Guenal":"Cardio",
      "Dr Didot":"Cardio","Dr Brathier":"Cardio","Dr Dechery":"Cardio","Dr Tabat":"Cardio","Dr Lounthone":"Cardio","Dr El Idrisse":"Cardio",
      "Dr Lemrini":"Cardio","Dr Seaux":"Cardio","Dr Athmani":"Cardio","Dr Chesnoy":"Cardio",
      "Dr Maiga":"Neuro-vasc","Dr Phan":"Neuro-vasc","Dr Chabbine":"Neuro-vasc","Dr Profiroiu":"Neuro-vasc","Dr Fanorena":"Neuro-vasc",
      "Dr Dai Tometin":"P√©diatre","Dr Ayaz":"P√©diatre","Dr Hefteh":"P√©diatre","Dr Benzid":"P√©diatre","Dr Gaisne":"P√©diatre","Dr Gatti":"P√©diatre",
      "Dr Ikomba":"P√©diatre","Dr Tresor":"P√©diatre","Dr Benhocine":"P√©diatre","Dr Toronga":"P√©diatre","Dr Mvogo":"P√©diatre","Dr Taylor":"P√©diatre",
      "Dr Chatue":"P√©diatre","Dr Torona":"P√©diatre",
      "Dr Bello":"Radiologie","Dr Chawa":"Radiologie","Dr IMADI":"Radiologie","Dr Gnonwa":"Radiologie","Dr Coatrieux":"Radiologie",
      "Dr Bouchibane":"Radiologie","Dr Adjimabou":"Radiologie","Dr Soumo":"Radiologie","Dr Didenjou":"Radiologie"
    };
    const inferService = (name)=> serviceMap[name?.trim()] || "‚Äî";

    /* ====== SERIALIZE ====== */
    function readTableRows(tableId, mapRow){
      const tbody = document.getElementById(tableId).querySelector('tbody');
      return Array.from(tbody.rows).map(mapRow);
    }
    function serializeAll(){
      return {
        medecins: readTableRows('medecinTable', (tr) => {
          const name = tr.cells[0].querySelector('input')?.value || '';
          const dect = tr.cells[2].querySelector('input')?.value || '';
          return { nom: name, service: inferService(name), dect };
        }),
        smurPrimaire: readTableRows('smurPrimaireTable', (tr) => ({
          nom: tr.cells[0].querySelector('input, select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        smurSecondaire: readTableRows('smurSecondaireTable', (tr) => ({
          nom: tr.cells[0].querySelector('input, select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        regulateurJour: (() => {
          const tb = document.querySelector('#regulateurJourTable tbody');
          return Array.from(tb.rows).map(tr => ({
            slot: tr.cells[0].textContent.trim(),
            nom: tr.querySelector('.rj-nom')?.value || '',
            dect: tr.querySelector('.rj-dect')?.value || ''
          }));
        })(),
        regulateurNuit: (() => {
          const tb = document.querySelector('#regulateurNuitTable tbody');
          return Array.from(tb.rows).map(tr => ({
            slot: tr.cells[0].textContent.trim(),
            nom: tr.querySelector('.rn-nom')?.value || '',
            dect: tr.querySelector('.rn-dect')?.value || ''
          }));
        })(),
        ambulanceGarde: (() => {
          const tbody = document.querySelector('#ambulanceGardeTable tbody');
          return Array.from(tbody.rows).map(tr => ({
            vehicule: tr.cells[0].textContent.trim(),
            nom:      tr.querySelector('.ag-nom')?.value || '',
            dect:     tr.querySelector('.ag-dect')?.value || ''
          }));
        })(),
        ambulanceSortie: readTableRows('ambulanceSortieTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        ambulanceGHT: readTableRows('ambulanceGHTTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        pharmacie: readTableRows('pharmacieTable', (tr) => ({
          nom: tr.cells[0].querySelector('input')?.value || '',
          adresse: tr.cells[1].querySelector('textarea')?.value || '',
          dect: tr.cells[2].querySelector('input')?.value || ''
        }))
      };
    }

    /* ====== RENDER/HYDRATE ====== */
    function renderRows(tbody, rows, renderCellHtmls){
      tbody.innerHTML = '';
      rows.forEach((row) => {
        const tr = tbody.insertRow();
        tr.innerHTML = renderCellHtmls(row);
      });
      if (tbody.parentElement.id === 'ambulanceSortieTable' || tbody.parentElement.id === 'ambulanceGHTTable') {
        tbody.querySelectorAll('select').forEach(sel=>{
          if (!sel.innerHTML.trim()) sel.innerHTML = renderAmbuOptions('');
        });
      }
    }

    function hydrateAll(data){
      data = data || {};

      // M√©decins
      renderRows($('#medecinTable tbody'), data.medecins || [], (row) => `
        <td><input list="medecinsList" value="${row.nom||''}" placeholder="Ex. Dr Dupont"/></td>
        <td><span class="service-badge">${inferService(row.nom||'')}</span></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // SMUR
      renderRows($('#smurPrimaireTable tbody'), data.smurPrimaire || [], (row)=>`
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
      renderRows($('#smurSecondaireTable tbody'), data.smurSecondaire || [], (row)=>`
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // R√©gulateurs
      renderRows(document.querySelector('#regulateurJourTable tbody'),
        REGULATEURS_JOUR.map(slot => {
          const found = (data.regulateurJour || []).find(r => (r.slot||'') === slot) || {};
          return { slot, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row)=>`
          <td class="reg-badge">${row.slot}</td>
          <td><select class="rj-nom">${renderRegOptions(row.nom)}</select></td>
          <td><input class="rj-dect" type="text" placeholder="DECT" value="${row.dect||''}"/></td>
        `
      );
      renderRows(document.querySelector('#regulateurNuitTable tbody'),
        REGULATEURS_NUIT.map(slot => {
          const found = (data.regulateurNuit || []).find(r => (r.slot||'') === slot) || {};
          return { slot, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row)=>`
          <td class="reg-badge">${row.slot}</td>
          <td><select class="rn-nom">${renderRegOptions(row.nom)}</select></td>
          <td><input class="rn-dect" type="text" placeholder="DECT" value="${row.dect||''}"/></td>
        `
      );

      // Ambulance de GARDE ‚Äî fixes
      renderRows(document.querySelector('#ambulanceGardeTable tbody'),
        VEHICULES_GARDE.map(v => {
          const found = (data.ambulanceGarde || []).find(r => (r.vehicule||'') === v) || {};
          return { vehicule: v, nom: found.nom || '', dect: found.dect || '' };
        }),
        (row) => `
          <td class="vehicule-badge">${row.vehicule}</td>
          <td><select class="ag-nom">${renderAmbuOptions(row.nom)}</select></td>
          <td><input class="ag-dect" type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        `
      );

      // Ambulances dynamiques
      renderRows($('#ambulanceSortieTable tbody'), data.ambulanceSortie || [], (row)=>`
        <td><select>${renderAmbuOptions(row.nom||'')}</select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
      renderRows($('#ambulanceGHTTable tbody'), data.ambulanceGHT || [], (row)=>`
        <td><select>${renderAmbuOptions(row.nom||'')}</select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Pharmacie ‚Äî grand tableau
      renderRows($('#pharmacieTable tbody'), data.pharmacie || [], (row)=>`
        <td class="pharm-nom"><input type="text" value="${row.nom||''}" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶" /></td>
        <td class="pharm-addr"><textarea placeholder="Adresse (rue, CP, ville)">${row.adresse||''}</textarea></td>
        <td class="pharm-dect"><input type="text" value="${row.dect||''}" placeholder="09 00 00 00 00" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
    }

    /* ====== SAVE / LOAD ====== */
    let debounceTimer = null;
    const DEBOUNCE_MS = 1200;
    let skipNextUpdate = false;

    function scheduleSave(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(saveAll, DEBOUNCE_MS); setSaving(true); }
    async function saveAll(){ const data = serializeAll(); skipNextUpdate = true; await set(dataRef(), data); setSaving(false); }

    function loadAndListen(){
      onValue(dataRef(), (snap)=>{
        if (skipNextUpdate){ skipNextUpdate = false; return; }
        hydrateAll(snap.val() || {});
        wireAutoSave();
        setSaving(false);
      });
    }

    /* ====== UI WIRING ====== */
    function wireAutoSave(){
      // M√©decins : badge service live
      $$('#medecinTable tbody input[list="medecinsList"]').forEach(inp=>{
        const update = () => {
          inp.closest('tr').cells[1].querySelector('.service-badge').textContent = inferService(inp.value);
          scheduleSave();
        };
        inp.oninput = update; inp.onchange = update;
      });
      $$('input, select, textarea').forEach(el=>{ el.oninput = scheduleSave; el.onchange = scheduleSave; });
    }

    // Raccourci CTRL/CMD+S
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAll(); }
    });

    // Toolbar
    document.getElementById('forceSaveBtn').addEventListener('click', saveAll);
    document.getElementById('newDayBtn').addEventListener('click', ()=>{
      currentKey = todayKey(); localStorage.setItem('gardeDayKey', currentKey); dayKeyEl.textContent = currentKey;
      hydrateAll({}); saveAll(); loadAndListen();
    });
    document.getElementById('clearDayBtn').addEventListener('click', async ()=>{
      if (confirm('Effacer toutes les donn√©es de la journ√©e ?')){ await remove(dataRef()); hydrateAll({}); saveAll(); }
    });

    // Actions g√©n√©riques
    window.deleteRow = (button)=>{ button.closest('tr').remove(); scheduleSave(); }

    // Ajout pour SMUR
    window.addRow = (button)=>{
      const wrap = button.closest('.board') || button.closest('.card');
      const table = wrap.querySelector('tbody');
      const tableEl = wrap.querySelector('table');
      const tableId = tableEl ? tableEl.id : '';
      const tr = table.insertRow();

      if (tableId === 'smurPrimaireTable' || tableId === 'smurSecondaireTable'){
        tr.innerHTML = `
          <td><input type="text" placeholder="Nom" /></td>
          <td><input type="text" placeholder="DECT" /></td>
          <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      }
      wireAutoSave(); scheduleSave();
    }

    // Ajout cibl√© pour Ambu Sortie / GHT
    window.addRowTo = function(tableId){
      const tbody = document.querySelector(`#${tableId} tbody`);
      if (!tbody) return;
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td><select>${renderAmbuOptions('')}</select></td>
        <td><input type="text" placeholder="DECT" /></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave(); scheduleSave();
    }

    // Pharmacie : ajouter une ligne
    window.addPharmacieRow = function(){
      const tbody = document.querySelector('#pharmacieTable tbody');
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td class="pharm-nom"><input type="text" placeholder="Grande Pharmacie du Centre, Pharmacie X‚Ä¶"/></td>
        <td class="pharm-addr"><textarea placeholder="Adresse (rue, CP, ville)"></textarea></td>
        <td class="pharm-dect"><input type="text" placeholder="09 00 00 00 00"/></td>
        <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave(); scheduleSave();
    }
// ‚ûï Ajouter une ligne dans le tableau "M√©decins"
window.addMedecinRow = function () {
  const tbody = document.querySelector('#medecinTable tbody');
  const tr = tbody.insertRow();
  tr.innerHTML = `
    <td><input list="medecinsList" placeholder="Ex. Dr Dupont" /></td>
    <td><span class="service-badge">‚Äî</span></td>
    <td><input type="text" placeholder="DECT" /></td>
    <td class="actions"><button onclick="deleteRow(this)">Supprimer</button></td>
  `;

  // branchement auto-save + MAJ du service en direct
  wireAutoSave();

  // Met √† jour le badge service imm√©diatement si un nom est d√©j√† tap√©
  const nameInput = tr.querySelector('input[list="medecinsList"]');
  const badge = tr.cells[1].querySelector('.service-badge');
  const updateService = () => { badge.textContent = inferService(nameInput.value); scheduleSave(); };
  nameInput.addEventListener('input', updateService);
  nameInput.addEventListener('change', updateService);

  scheduleSave();
};
    // Rendu Ambulance de Garde (fixe) au tout premier chargement
    function renderAmbuGardeRows(tbody, data){
      tbody.innerHTML = '';
      VEHICULES_GARDE.forEach(v=>{
        const found = (data || []).find(r=> (r.vehicule||'')===v) || {};
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td class="vehicule-badge">${v}</td>
          <td><select class="ag-nom">${renderAmbuOptions(found.nom||'')}</select></td>
          <td><input class="ag-dect" type="text" placeholder="DECT" value="${found.dect||''}"/></td>`;
      });
    }

    // Boot
    document.getElementById('date').textContent =
      new Date().toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

    function firstLoad(){
      onValue(dataRef(), (snap)=>{
        const val = snap.val() || {};
        hydrateAll(val);
        renderAmbuGardeRows(document.querySelector('#ambulanceGardeTable tbody'), val.ambulanceGarde);
        wireAutoSave();
        setSaving(false);
      }, { onlyOnce:true });
      loadAndListen();
    }
    firstLoad();
  </script>
</body>
</html>
