<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tableau de Garde - HÃ´pital (Firebase)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    .header { background: #ff7f50; color: #fff; padding: 20px; text-align: center; font-size: 24px; }
    .header #date { font-size: 18px; margin-top: 10px; }
    .container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; padding: 20px; }
    .left-container { display: flex; flex-direction: column; gap: 20px; }
    .right-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .table-container { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    .table-container table { width: 100%; border-collapse: collapse; }
    .table-container th, .table-container td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .table-container th { background: #ff7f50; color: #fff; }
    .section-header { font-size: 18px; margin-bottom: 10px; color: #ff7f50; font-weight: bold; text-align: center; }
    button { background: #333; color: #fff; padding: 10px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #ff7f50; }
    .smur-primaire th { background: #ffa07a; }
    .smur-secondaire th { background: #87cefa; }
    .regulateur th { background: #32cd32; }
    .ambulance-garde th { background: #ff6347; }
    .ambulance-sortie th { background: #dda0dd; }
    .pharmacie-garde th { background: #ffd700; }
    .administrateur-garde th { background: #8a2be2; }
    .sync-bar { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #eee; padding: 8px 12px; font-size: 14px; display: flex; gap: 12px; align-items: center; justify-content: center; z-index: 5; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .dot.idle { background: #bbb; }
    .dot.saving { background: #f0ad4e; animation: pulse 1.2s infinite; }
    .dot.online { background: #28a745; }
    @keyframes pulse { 0%{ transform: scale(1);} 50%{ transform: scale(1.2);} 100%{ transform: scale(1);} }
    .toolbar { display:flex; gap:8px; justify-content:center; margin: 10px 20px 0; flex-wrap: wrap; }
    .toolbar button.secondary { background:#666; }
    .toolbar button.danger { background:#b00020; }
  </style>
</head>
<body>
  <div class="header">
    Tableau de Garde - HÃ´pital
    <div id="date"></div>
  </div>

  <div class="sync-bar">
    <span class="dot idle" id="syncDot" title="Ã‰tat sync"></span>
    <span id="syncText">PrÃªt</span>
    <span id="lastSaved" style="opacity:.7"></span>
  </div>

  <div class="toolbar">
    <button id="forceSaveBtn" class="secondary">ðŸ’¾ Enregistrer maintenant</button>
    <button id="newDayBtn" class="secondary" title="Passe sur la date du jour">ðŸ“… Nouvelle journÃ©e</button>
    <button id="clearDayBtn" class="danger" title="Efface la journÃ©e en cours">ðŸ§¹ Vider la journÃ©e</button>
    <span style="opacity:.7">ClÃ© du jour : <strong id="dayKey"></strong></span>
  </div>

  <div class="container">
    <!-- Colonne gauche : MÃ©decins -->
    <div class="left-container">
      <div class="table-container">
        <div class="section-header">MÃ©decin</div>
        <table id="medecinTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Service</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Ligne propre, sans ${row...} et balises valides -->
            <tr>
              <td>
                <select>
                  <optgroup label="RÃ©a">
                    <option>Dr Vaz</option>
                    <option>Dr Hamizi</option>
                    <option>Dr Kinda</option>
                    <option>Dr Voellmy</option>
                    <option>Dr Njatomalala</option>
                    <option>Dr Chabbi</option>
                    <option>Dr Mortreux</option>
                    <option>Dr Chedjieu</option>
                    <option>Dr Rey</option>
                  </optgroup>
                  <optgroup label="Cardio">
                    <option>Dr Heurtebise</option>
                    <option>Dr Laporal</option>
                    <option>Dr Jnifene</option>
                    <option>Dr Akiel</option>
                    <option>Dr Guenal</option>
                    <option>Dr Didot</option>
                    <option>Dr Brathier</option>
                    <option>Dr Dechery</option>
                    <option>Dr Tabat</option>
                    <option>Dr Lounthone</option>
                    <option>Dr El Idrisse</option>
                    <option>Dr Lemrini</option>
                    <option>Dr Seaux</option>
                    <option>Dr Athmani</option>
                    <option>Dr Chesnoy</option>
                  </optgroup>
                  <optgroup label="Neuro-Vasc">
                    <option>Dr Maiga</option>
                    <option>Dr Phan</option>
                    <option>Dr Chabbine</option>
                    <option>Dr Profiroiu</option>
                    <option>Dr Fanorena</option>
                  </optgroup>
                  <optgroup label="PÃ©diatre">
                    <option>Dr Dai Tometin</option>
                    <option>Dr Ayaz</option>
                    <option>Dr Hefteh</option>
                    <option>Dr Benzid</option>
                    <option>Dr Gaisne</option>
                    <option>Dr Gatti</option>
                    <option>Dr Ikomba</option>
                    <option>Dr Tresor</option>
                    <option>Dr Benhocine</option>
                    <option>Dr Toronga</option>
                    <option>Dr Mvogo</option>
                    <option>Dr Taylor</option>
                    <option>Dr Chatue</option>
                    <option>Dr Torona</option>
                  </optgroup>
                  <optgroup label="Radiologues/IRM">
                    <option>Dr Bello</option>
                    <option>Dr Chawa</option>
                    <option>Dr IMADI</option>
                    <option>Dr Gnonwa</option>
                    <option>Dr Coatrieux</option>
                    <option>Dr Bouchibane</option>
                    <option>Dr Adjimabou</option>
                    <option>Dr Soumo</option>
                    <option>Dr Didenjou</option>
                  </optgroup>
                </select>
              </td>
              <td>
                <select>
                  <option>RÃ©animation</option>
                  <option>Cardio</option>
                  <option>Radiologie</option>
                  <option>Neuro-vasc</option>
                  <option>PÃ©diatre</option>
                </select>
              </td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addMedecinRow()">Ajouter une ligne MÃ©decin</button>
      </div>
    </div>

    <!-- Colonne droite : autres tableaux -->
    <div class="right-container">
      <!-- SMUR Primaire -->
      <div class="table-container smur-primaire">
        <div class="section-header">SMUR Primaire</div>
        <table id="smurPrimaireTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" placeholder="Nom"></td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>

      <!-- SMUR Secondaire -->
      <div class="table-container smur-secondaire">
        <div class="section-header">SMUR Secondaire</div>
        <table id="smurSecondaireTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" placeholder="Nom"></td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>

      <!-- RÃ©gulateur -->
      <div class="table-container regulateur">
        <div class="section-header">RÃ©gulateur</div>
        <table id="regulateurTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><select><option>Nom 1</option><option>Nom 2</option></select></td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>

      <!-- Ambulance de Garde -->
      <div class="table-container ambulance-garde">
        <div class="section-header">Ambulance de Garde</div>
        <table id="ambulanceGardeTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><select><option>Nom 1</option><option>Nom 2</option></select></td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>

      <!-- Ambulance de Sortie -->
      <div class="table-container ambulance-sortie">
        <div class="section-header">Ambulance de Sortie</div>
        <table id="ambulanceSortieTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><select><option>Nom 1</option><option>Nom 2</option></select></td>
              <td><input type="text" placeholder="DECT"></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>

      <!-- Pharmacie de Garde -->
      <div class="table-container pharmacie-garde">
        <div class="section-header">Pharmacie de Garde</div>
        <table id="pharmacieTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Adresse</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" placeholder="Nom" /></td>
              <td><input type="text" placeholder="Adresse" /></td>
              <td><input type="text" placeholder="DECT" /></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addPharmacieRow()">Ajouter une ligne</button>
      </div>

      <!-- Administrateur de Garde -->
      <div class="table-container administrateur-garde">
        <div class="section-header">Administrateur de Garde</div>
        <table id="administrateurTable">
          <thead>
            <tr>
              <th>Nom</th>
              <th>DECT</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><select><option>Nom 1</option><option>Nom 2</option></select></td>
              <td><input type="text" placeholder="DECT" /></td>
              <td><button onclick="deleteRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button onclick="addRow(this)">Ajouter une ligne</button>
      </div>
    </div>
  </div>

  <!-- App + Realtime Database -->
  <script type="module">
    // ====== Firebase (CDN, v10+) ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDG8Tjus5no-pJpmd3tOwydo-QY8ERhH8Y",
      authDomain: "tabgarde-16180.firebaseapp.com",
      databaseURL: "https://tabgarde-16180-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tabgarde-16180",
      storageBucket: "tabgarde-16180.firebasestorage.app",
      messagingSenderId: "1087347813441",
      appId: "1:1087347813441:web:68c63e7203020dd114aac0",
      measurementId: "G-5KL9P8QW7J"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ====== Helpers ======
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const dayKeyEl = document.getElementById('dayKey');
    const syncDot  = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');
    const lastSaved= document.getElementById('lastSaved');

    const todayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
    let currentKey = localStorage.getItem('gardeDayKey') || todayKey();
    dayKeyEl.textContent = currentKey;

    const dataRef = () => ref(db, `tableauGarde/${currentKey}`);

    const setSaving = (isSaving) => {
      if (isSaving) {
        syncDot.classList.remove('idle','online');
        syncDot.classList.add('saving');
        syncText.textContent = 'Sauvegardeâ€¦';
      } else {
        syncDot.classList.remove('idle','saving');
        syncDot.classList.add('online');
        syncText.textContent = 'SynchronisÃ©';
        lastSaved.textContent = `â€¢ Dernier enregistrement: ${new Date().toLocaleTimeString('fr-FR')}`;
      }
    };

    // ====== Serialization ======
    function readTableRows(tableId, mapRow) {
      const tbody = document.getElementById(tableId).querySelector('tbody');
      return Array.from(tbody.rows).map(mapRow);
    }

    function serializeAll() {
      return {
        medecins: readTableRows('medecinTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          service: tr.cells[1].querySelector('select')?.value || '',
          dect: tr.cells[2].querySelector('input')?.value || ''
        })),
        smurPrimaire: readTableRows('smurPrimaireTable', (tr) => ({
          nom: (tr.cells[0].querySelector('input')?.value ?? tr.cells[0].querySelector('select')?.value) || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        smurSecondaire: readTableRows('smurSecondaireTable', (tr) => ({
          nom: (tr.cells[0].querySelector('input')?.value ?? tr.cells[0].querySelector('select')?.value) || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        regulateur: readTableRows('regulateurTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        ambulanceGarde: readTableRows('ambulanceGardeTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        ambulanceSortie: readTableRows('ambulanceSortieTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        })),
        pharmacie: readTableRows('pharmacieTable', (tr) => ({
          nom: tr.cells[0].querySelector('input')?.value || '',
          adresse: tr.cells[1].querySelector('input')?.value || '',
          dect: tr.cells[2].querySelector('input')?.value || ''
        })),
        administrateur: readTableRows('administrateurTable', (tr) => ({
          nom: tr.cells[0].querySelector('select')?.value || '',
          dect: tr.cells[1].querySelector('input')?.value || ''
        }))
      };
    }

    function renderRows(tbody, rows, renderCellHtmls) {
      tbody.innerHTML = '';
      rows.forEach((row) => {
        const tr = tbody.insertRow();
        tr.innerHTML = renderCellHtmls(row);
      });
    }

    function hydrateAll(snapshotVal) {
      const data = snapshotVal || {};

      // MÃ©decins (corrigÃ© : on cible bien #medecinTable)
      renderRows(document.querySelector('#medecinTable tbody'), data.medecins || [], (row) => `
        <td>
          <select class="medecin-nom">
            <optgroup label="RÃ©a">
              <option ${row.nom==="Dr Vaz"?'selected':''}>Dr Vaz</option>
              <option ${row.nom==="Dr Hamizi"?'selected':''}>Dr Hamizi</option>
              <option ${row.nom==="Dr Kinda"?'selected':''}>Dr Kinda</option>
              <option ${row.nom==="Dr Voellmy"?'selected':''}>Dr Voellmy</option>
              <option ${row.nom==="Dr Njatomalala"?'selected':''}>Dr Njatomalala</option>
              <option ${row.nom==="Dr Chabbi"?'selected':''}>Dr Chabbi</option>
              <option ${row.nom==="Dr Mortreux"?'selected':''}>Dr Mortreux</option>
              <option ${row.nom==="Dr Chedjieu"?'selected':''}>Dr Chedjieu</option>
              <option ${row.nom==="Dr Rey"?'selected':''}>Dr Rey</option>
            </optgroup>
            <optgroup label="Cardio">
              <option ${row.nom==="Dr Heurtebise"?'selected':''}>Dr Heurtebise</option>
              <option ${row.nom==="Dr Laporal"?'selected':''}>Dr Laporal</option>
              <option ${row.nom==="Dr Jnifene"?'selected':''}>Dr Jnifene</option>
              <option ${row.nom==="Dr Akiel"?'selected':''}>Dr Akiel</option>
              <option ${row.nom==="Dr Guenal"?'selected':''}>Dr Guenal</option>
              <option ${row.nom==="Dr Didot"?'selected':''}>Dr Didot</option>
              <option ${row.nom==="Dr Brathier"?'selected':''}>Dr Brathier</option>
              <option ${row.nom==="Dr Dechery"?'selected':''}>Dr Dechery</option>
              <option ${row.nom==="Dr Tabat"?'selected':''}>Dr Tabat</option>
              <option ${row.nom==="Dr Lounthone"?'selected':''}>Dr Lounthone</option>
              <option ${row.nom==="Dr El Idrisse"?'selected':''}>Dr El Idrisse</option>
              <option ${row.nom==="Dr Lemrini"?'selected':''}>Dr Lemrini</option>
              <option ${row.nom==="Dr Seaux"?'selected':''}>Dr Seaux</option>
              <option ${row.nom==="Dr Athmani"?'selected':''}>Dr Athmani</option>
              <option ${row.nom==="Dr Chesnoy"?'selected':''}>Dr Chesnoy</option>
            </optgroup>
            <optgroup label="Neuro-Vasc">
              <option ${row.nom==="Dr Maiga"?'selected':''}>Dr Maiga</option>
              <option ${row.nom==="Dr Phan"?'selected':''}>Dr Phan</option>
              <option ${row.nom==="Dr Chabbine"?'selected':''}>Dr Chabbine</option>
              <option ${row.nom==="Dr Profiroiu"?'selected':''}>Dr Profiroiu</option>
              <option ${row.nom==="Dr Fanorena"?'selected':''}>Dr Fanorena</option>
            </optgroup>
            <optgroup label="PÃ©diatre">
              <option ${row.nom==="Dr Dai Tometin"?'selected':''}>Dr Dai Tometin</option>
              <option ${row.nom==="Dr Ayaz"?'selected':''}>Dr Ayaz</option>
              <option ${row.nom==="Dr Hefteh"?'selected':''}>Dr Hefteh</option>
              <option ${row.nom==="Dr Benzid"?'selected':''}>Dr Benzid</option>
              <option ${row.nom==="Dr Gaisne"?'selected':''}>Dr Gaisne</option>
              <option ${row.nom==="Dr Gatti"?'selected':''}>Dr Gatti</option>
              <option ${row.nom==="Dr Ikomba"?'selected':''}>Dr Ikomba</option>
              <option ${row.nom==="Dr Tresor"?'selected':''}>Dr Tresor</option>
              <option ${row.nom==="Dr Benhocine"?'selected':''}>Dr Benhocine</option>
              <option ${row.nom==="Dr Toronga"?'selected':''}>Dr Toronga</option>
              <option ${row.nom==="Dr Mvogo"?'selected':''}>Dr Mvogo</option>
              <option ${row.nom==="Dr Taylor"?'selected':''}>Dr Taylor</option>
              <option ${row.nom==="Dr Chatue"?'selected':''}>Dr Chatue</option>
              <option ${row.nom==="Dr Torona"?'selected':''}>Dr Torona</option>
            </optgroup>
            <optgroup label="Radiologues/IRM">
              <option ${row.nom==="Dr Bello"?'selected':''}>Dr Bello</option>
              <option ${row.nom==="Dr Chawa"?'selected':''}>Dr Chawa</option>
              <option ${row.nom==="Dr IMADI"?'selected':''}>Dr IMADI</option>
              <option ${row.nom==="Dr Gnonwa"?'selected':''}>Dr Gnonwa</option>
              <option ${row.nom==="Dr Coatrieux"?'selected':''}>Dr Coatrieux</option>
              <option ${row.nom==="Dr Bouchibane"?'selected':''}>Dr Bouchibane</option>
              <option ${row.nom==="Dr Adjimabou"?'selected':''}>Dr Adjimabou</option>
              <option ${row.nom==="Dr Soumo"?'selected':''}>Dr Soumo</option>
              <option ${row.nom==="Dr Didenjou"?'selected':''}>Dr Didenjou</option>
            </optgroup>
          </select>
        </td>
        <td>
          <select class="medecin-service">
            ${["RÃ©animation","Cardio","Radiologie","Neuro-vasc","PÃ©diatre"]
              .map((s) => `<option ${row.service===s?'selected':''}>${s}</option>`)
              .join('')}
          </select>
        </td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // SMUR Primaire
      renderRows(document.querySelector('#smurPrimaireTable tbody'), data.smurPrimaire || [], (row) => `
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // SMUR Secondaire
      renderRows(document.querySelector('#smurSecondaireTable tbody'), data.smurSecondaire || [], (row) => `
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // RÃ©gulateur
      renderRows(document.querySelector('#regulateurTable tbody'), data.regulateur || [], (row) => `
        <td><select>
          <option ${row.nom==="Dr Agbessi 7886"?'selected':''}>Dr Agbessi 7886</option>
          <option ${row.nom==="Dr Arar 8216"?'selected':''}>Dr Arar 8216</option>
          <option ${row.nom==="Dr Belghalem"?'selected':''}>Dr Belghalem</option>
          <option ${row.nom==="Dr Campet"?'selected':''}>Dr Campet</option>
          <option ${row.nom==="Dr Carlos 6497"?'selected':''}>Dr Carlos 6497</option>
          <option ${row.nom==="Dr Chereau"?'selected':''}>Dr Chereau</option>
          <option ${row.nom==="Dr Chomono"?'selected':''}>Dr Chomono</option>
          <option ${row.nom==="Dr Cochonneau 7895"?'selected':''}>Dr Cochonneau 7895</option>
          <option ${row.nom==="Dr Dechery 7309"?'selected':''}>Dr Dechery 7309</option>
          <option ${row.nom==="Dr Dorion 7313"?'selected':''}>Dr Dorion 7313</option>
          <option ${row.nom==="Dr Gonzales de Linares"?'selected':''}>Dr Gonzales de Linares</option>
          <option ${row.nom==="Dr Hibon Ricard"?'selected':''}>Dr Hibon Ricard</option>
          <option ${row.nom==="Dr Labbens 7350"?'selected':''}>Dr Labbens 7350</option>
          <option ${row.nom==="Dr Mazuir 7366"?'selected':''}>Dr Mazuir 7366</option>
          <option ${row.nom==="Dr Meyer 6412"?'selected':''}>Dr Meyer 6412</option>
          <option ${row.nom==="Dr Michel"?'selected':''}>Dr Michel</option>
          <option ${row.nom==="Dr Mirat"?'selected':''}>Dr Mirat</option>
          <option ${row.nom==="Dr Nasalan 7320"?'selected':''}>Dr Nasalan 7320</option>
          <option ${row.nom==="Dr Nuskovski"?'selected':''}>Dr Nuskovski</option>
          <option ${row.nom==="Dr Paris"?'selected':''}>Dr Paris</option>
          <option ${row.nom==="Dr Rabec"?'selected':''}>Dr Rabec</option>
          <option ${row.nom==="Dr Shehata"?'selected':''}>Dr Shehata</option>
          <option ${row.nom==="Dr Santiago"?'selected':''}>Dr Santiago</option>
          <option ${row.nom==="Dr Sokpoh"?'selected':''}>Dr Sokpoh</option>
        </select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Ambulance de Garde
      renderRows(document.querySelector('#ambulanceGardeTable tbody'), data.ambulanceGarde || [], (row) => `
        <td><select>
          <option ${row.nom==="2000"?'selected':''}>2000</option>
          <option ${row.nom==="Atlas"?'selected':''}>Atlas</option>
          <option ${row.nom==="Avaricum"?'selected':''}>Avaricum</option>
          <option ${row.nom==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${row.nom==="JHL"?'selected':''}>JHL</option>
          <option ${row.nom==="Marquet"?'selected':''}>Marquet</option>
          <option ${row.nom==="Mazer"?'selected':''}>Mazer</option>
          <option ${row.nom==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
          <option ${row.nom==="MillÃ©rioux"?'selected':''}>MillÃ©rioux</option>
          <option ${row.nom==="Pinson"?'selected':''}>Pinson</option>
          <option ${row.nom==="VMA"?'selected':''}>VMA</option>
          <optgroup label="Ambu Vz">
            <option ${row.nom==="AndrÃ©"?'selected':''}>AndrÃ©</option>
            <option ${row.nom==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
            <option ${row.nom==="Petitjean"?'selected':''}>Petitjean</option>
            <option ${row.nom==="St ExupÃ©ry"?'selected':''}>St ExupÃ©ry</option>
            <option ${row.nom==="Beuze Prev"?'selected':''}>Beuze Prev</option>
            <option ${row.nom==="Castellois"?'selected':''}>Castellois</option>
            <option ${row.nom==="Ducreux"?'selected':''}>Ducreux</option>
            <option ${row.nom==="Guillemin"?'selected':''}>Guillemin</option>
            <option ${row.nom==="LigniÃ¨res"?'selected':''}>LigniÃ¨res</option>
            <option ${row.nom==="Pasquet"?'selected':''}>Pasquet</option>
            <option ${row.nom==="St Amand"?'selected':''}>St Amand</option>
            <option ${row.nom==="Savignat"?'selected':''}>Savignat</option>
            <option ${row.nom==="JHL"?'selected':''}>JHL</option>
            <option ${row.nom==="Marquet"?'selected':''}>Marquet</option>
            <option ${row.nom==="MillÃ©rioux"?'selected':''}>MillÃ©rioux</option>
            <option ${row.nom==="Auger"?'selected':''}>Auger</option>
            <option ${row.nom==="Bengy"?'selected':''}>Bengy</option>
            <option ${row.nom==="VallÃ©e de l'Aubois"?'selected':''}>VallÃ©e de l'Aubois</option>
            <option ${row.nom==="Beuze PrÃ©veranges"?'selected':''}>Beuze PrÃ©veranges</option>
            <option ${row.nom==="Castellois"?'selected':''}>Castellois</option>
            <option ${row.nom==="Ducreux"?'selected':''}>Ducreux</option>
            <option ${row.nom==="Guillemin"?'selected':''}>Guillemin</option>
            <option ${row.nom==="LigniÃ¨res"?'selected':''}>LigniÃ¨res</option>
            <option ${row.nom==="Pasquet"?'selected':''}>Pasquet</option>
          </optgroup>
        </select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Ambulance de Sortie
      renderRows(document.querySelector('#ambulanceSortieTable tbody'), data.ambulanceSortie || [], (row) => `
        <td><select>
          <option ${row.nom==="2000"?'selected':''}>2000</option>
          <option ${row.nom==="AndrÃ©"?'selected':''}>AndrÃ©</option>
          <option ${row.nom==="Atlas"?'selected':''}>Atlas</option>
          <option ${row.nom==="Auger"?'selected':''}>Auger</option>
          <option ${row.nom==="Avaricum"?'selected':''}>Avaricum</option>
          <option ${row.nom==="Bengy"?'selected':''}>Bengy</option>
          <option ${row.nom==="Beuze P"?'selected':''}>Beuze P</option>
          <option ${row.nom==="Castellois"?'selected':''}>Castellois</option>
          <option ${row.nom==="Ducreux"?'selected':''}>Ducreux</option>
          <option ${row.nom==="Guillemin"?'selected':''}>Guillemin</option>
          <option ${row.nom==="JHL"?'selected':''}>JHL</option>
          <option ${row.nom==="LigniÃ¨res"?'selected':''}>LigniÃ¨res</option>
          <option ${row.nom==="Mazer"?'selected':''}>Mazer</option>
          <option ${row.nom==="MillÃ©rioux"?'selected':''}>MillÃ©rioux</option>
          <option ${row.nom==="Marquet"?'selected':''}>Marquet</option>
          <option ${row.nom==="Mehun ambulances"?'selected':''}>Mehun ambulances</option>
          <option ${row.nom==="Pasquet"?'selected':''}>Pasquet</option>
          <option ${row.nom==="Petitjean"?'selected':''}>Petitjean</option>
          <option ${row.nom==="Pinson"?'selected':''}>Pinson</option>
          <option ${row.nom==="St Amand"?'selected':''}>St Amand</option>
          <option ${row.nom==="St ExupÃ©ry"?'selected':''}>St ExupÃ©ry</option>
          <option ${row.nom==="Savignat"?'selected':''}>Savignat</option>
          <option ${row.nom==="VallÃ©e de l'Aubois"?'selected':''}>VallÃ©e de l'Aubois</option>
          <option ${row.nom==="VMA"?'selected':''}>VMA</option>
        </select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Pharmacie
      renderRows(document.querySelector('#pharmacieTable tbody'), data.pharmacie || [], (row) => `
        <td><input type="text" placeholder="Nom" value="${row.nom||''}" /></td>
        <td><input type="text" placeholder="Adresse" value="${row.adresse||''}" /></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);

      // Administrateur
      renderRows(document.querySelector('#administrateurTable tbody'), data.administrateur || [], (row) => `
        <td><select>
          <option ${row.nom==="Apert Mme"?'selected':''}>Apert Mme</option>
          <option ${row.nom==="Aulibert Mme"?'selected':''}>Aulibert Mme</option>
          <option ${row.nom==="Benoist M."?'selected':''}>Benoist M.</option>
          <option ${row.nom==="Descouts Mme"?'selected':''}>Descouts Mme</option>
          <option ${row.nom==="Dhorbait Mme"?'selected':''}>Dhorbait Mme</option>
          <option ${row.nom==="Fauquembergue M."?'selected':''}>Fauquembergue M.</option>
          <option ${row.nom==="Halin M."?'selected':''}>Halin M.</option>
          <option ${row.nom==="Hunault M."?'selected':''}>Hunault M.</option>
          <option ${row.nom==="Le Heiget M."?'selected':''}>Le Heiget M.</option>
          <option ${row.nom==="Le tarnec Mme"?'selected':''}>Le tarnec Mme</option>
          <option ${row.nom==="Mahut M."?'selected':''}>Mahut M.</option>
          <option ${row.nom==="Mercier M."?'selected':''}>Mercier M.</option>
          <option ${row.nom==="Osten Mme"?'selected':''}>Osten Mme</option>
          <option ${row.nom==="Paoletti - Bes Mme"?'selected':''}>Paoletti - Bes Mme</option>
          <option ${row.nom==="Perier Mme"?'selected':''}>Perier Mme</option>
          <option ${row.nom==="Tomatis Mme"?'selected':''}>Tomatis Mme</option>
          <option ${row.nom==="Vigneron Mme"?'selected':''}>Vigneron Mme</option>
          <option ${row.nom==="Vo Dinh M."?'selected':''}>Vo Dinh M.</option>
        </select></td>
        <td><input type="text" placeholder="DECT" value="${row.dect||''}" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>
      `);
    }

    // ====== Save / Load ======
    let debounceTimer = null;
    function scheduleSave() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(saveAll, 400);
      setSaving(true);
    }

    async function saveAll() {
      const data = serializeAll();
      await set(dataRef(), data);
      setSaving(false);
    }

    function loadAndListen() {
      onValue(dataRef(), (snap) => {
        const val = snap.val();
        if (val) {
          hydrateAll(val);
        } else {
          hydrateAll({});
        }
        wireAutoSave();
        setSaving(false);
      });
    }

    // ====== UI wiring ======
    function wireAutoSave() {
      $$('input, select').forEach(el => {
        el.oninput = scheduleSave;
        el.onchange = scheduleSave;
      });
    }

    document.getElementById('forceSaveBtn').addEventListener('click', saveAll);

    document.getElementById('newDayBtn').addEventListener('click', () => {
      currentKey = todayKey();
      localStorage.setItem('gardeDayKey', currentKey);
      dayKeyEl.textContent = currentKey;
      hydrateAll({});
      saveAll();
      loadAndListen();
    });

    document.getElementById('clearDayBtn').addEventListener('click', async () => {
      if (confirm('Effacer toutes les donnÃ©es de la journÃ©e ?')) {
        await remove(dataRef());
        hydrateAll({});
        saveAll();
      }
    });

    // ====== Fonctions globales ======
    window.deleteRow = function(button) {
      const row = button.parentNode.parentNode;
      row.parentNode.removeChild(row);
      scheduleSave();
    }

    window.addRow = function(button) {
      const table = button.parentNode.querySelector('tbody');
      const tableEl = button.parentNode.querySelector('table');
      const tableId = tableEl ? tableEl.id : '';
      const newRow = table.insertRow();

      let firstCellHtml = '';
      if (tableId === 'smurPrimaireTable' || tableId === 'smurSecondaireTable') {
        firstCellHtml = '<input type="text" placeholder="Nom" />';
      } else {
        firstCellHtml = '<select><option>MÃ©decin</option><option>Ambulancier</option></select>';
      }

      newRow.innerHTML = `
        <td>${firstCellHtml}</td>
        <td><input type="text" placeholder="DECT" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>`;

      wireAutoSave();
      scheduleSave();
    }

    window.addPharmacieRow = function() {
      const table = document.querySelector('#pharmacieTable tbody');
      const newRow = table.insertRow();
      newRow.innerHTML = `
        <td><input type="text" placeholder="Nom" /></td>
        <td><input type="text" placeholder="Adresse" /></td>
        <td><input type="text" placeholder="DECT" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave();
      scheduleSave();
    }

    // âœ… CorrigÃ© : pas de "row" ici
    window.addMedecinRow = function() {
      const table = document.querySelector('#medecinTable tbody');
      const newRow = table.insertRow();
      newRow.innerHTML = `
        <td>
          <select>
            <optgroup label="RÃ©a">
              <option>Dr Vaz</option>
              <option>Dr Hamizi</option>
              <option>Dr Kinda</option>
              <option>Dr Voellmy</option>
              <option>Dr Njatomalala</option>
              <option>Dr Chabbi</option>
              <option>Dr Mortreux</option>
              <option>Dr Chedjieu</option>
              <option>Dr Rey</option>
            </optgroup>
            <optgroup label="Cardio">
              <option>Dr Ricoulleau</option>
              <option>Dr Heurtebise</option>
              <option>Dr Laporal</option>
              <option>Dr Jnifene</option>
              <option>Dr Akiel</option>
              <option>Dr Guenal</option>
              <option>Dr Didot</option>
              <option>Dr Brathier</option>
              <option>Dr Dechery</option>
              <option>Dr Tabat</option>
              <option>Dr Lounthone</option>
              <option>Dr El Idrisse</option>
              <option>Dr Lemrini</option>
              <option>Dr Seaux</option>
              <option>Dr Athmani</option>
              <option>Dr Chesnoy</option>
            </optgroup>
            <optgroup label="Neuro-Vasc">
              <option>Dr Maiga</option>
              <option>Dr Phan</option>
              <option>Dr Chabbine</option>
              <option>Dr Profiroiu</option>
              <option>Dr Fanorena</option>
            </optgroup>
            <optgroup label="PÃ©diatre">
              <option>Dr Dai Tometin</option>
              <option>Dr Ayaz</option>
              <option>Dr Hefteh</option>
              <option>Dr Benzid</option>
              <option>Dr Gaisne</option>
              <option>Dr Gatti</option>
              <option>Dr Ikomba</option>
              <option>Dr Tresor</option>
              <option>Dr Benhocine</option>
              <option>Dr Toronga</option>
              <option>Dr Mvogo</option>
              <option>Dr Taylor</option>
              <option>Dr Chatue</option>
              <option>Dr Torona</option>
            </optgroup>
            <optgroup label="Radiologues/IRM">
              <option>Dr Bello</option>
              <option>Dr Chawa</option>
              <option>Dr IMADI</option>
              <option>Dr Gnonwa</option>
              <option>Dr Coatrieux</option>
              <option>Dr Bouchibane</option>
              <option>Dr Adjimabou</option>
              <option>Dr Soumo</option>
              <option>Dr Didenjou</option>
            </optgroup>
          </select>
        </td>
        <td>
          <select>
            <option>Cardio</option>
            <option>Urologie</option>
            <option>RÃ©animation</option>
            <option>Neuro-vasc</option>
            <option>PÃ©diatre</option>
            <option>Radiologie</option>
          </select>
        </td>
        <td><input type="text" placeholder="DECT" /></td>
        <td><button onclick="deleteRow(this)">Supprimer</button></td>`;
      wireAutoSave();
      scheduleSave();
    }

    // ====== Boot ======
    document.getElementById('date').textContent = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    wireAutoSave();
    loadAndListen();
  </script>
</body>
</html>
